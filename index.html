<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuDesTrack - Keuangan Pasangan</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        .animate-spin-slow {
            animation: spin 5s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* Mengatasi masalah tinggi minimum pada perangkat seluler */
        html, body, #root {
            height: 100%;
        }
        #root {
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white">
    <div id="root"></div>

    <!-- React & ReactDOM CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone untuk Transpilasi JSX di Browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variabel global yang disediakan oleh lingkungan Canvas
        // PENTING: Ganti nilai ini dengan konfigurasi Firebase Anda yang sebenarnya jika dijalankan di luar Canvas
        window.__app_id = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        window.__firebase_config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyCkYFTsdefDKWNlELHkZTYaejLx1LzzhiU",
            authDomain: "rencana-kita.firebaseapp.com",
            projectId: "rencana-kita",
            storageBucket: "rencana-kita.firebasestorage.app",
            messagingSenderId: "933508706878",
            appId: "1:933508706878:web:36092931498a9605b9d76f"
        };

        // Buat objek global untuk Firebase agar dapat diakses oleh skrip Babel
        window.firebase = {
            initializeApp,
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs
        };
    </script>

    <!-- Kode Aplikasi React Anda -->
    <script type="text/babel">
        // Mengakses objek Firebase dari window
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
                getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } = window.firebase;

        const { useState, useEffect, createContext, useContext } = React;
        const { PieChart, Pie, BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell } = Recharts; // Recharts dari global

        // Ikon dari Lucide React (simulasi, karena tidak ada impor langsung di HTML)
        // Untuk demo ini, kita akan menggunakan ikon yang sudah didefinisikan atau teks/emoji
        const Home = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>;
        const DollarSign = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>;
        const BarChart2 = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>;
        const Target = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>;
        const Heart = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>;
        const Calendar = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>;
        const CheckSquare = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>;
        const Book = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20V6.5A2.5 2.5 0 0 0 17.5 4h-11A2.5 2.5 0 0 0 4 6.5v13z"></path></svg>;
        const Bell = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>;
        const Settings = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09A1.65 1.65 0 0 0 15 4.6a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>;
        const Menu = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>;
        const X = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const Sun = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>;
        const Moon = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>;
        const Gift = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 12 12 20 4 12"></polyline><line x1="12" y1="20" x2="12" y2="4"></line><path d="M20 4h-6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path></svg>;
        const Plus = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const ChevronLeft = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="15 18 9 12 15 6"></polyline></svg>;
        const Wallet = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 12H3a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V14a2 2 0 0 0-2-2z"></path><path d="M22 7h-6a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"></path></svg>;
        const TrendingUp = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="17 1 21 5 17 9"></polyline><path d="M21 5H10a2 2 0 0 0-2 2v12"></path></svg>;
        const TrendingDown = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="17 13 21 17 17 21"></polyline><path d="M21 17H10a2 2 0 0 1-2-2V3"></path></svg>;
        const Save = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>;
        const Users = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>;
        const Utensils = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"></path><path d="M7 2v20"></path><path d="M21 15V2h-4a2 2 0 0 0-2 2v11"></path><path d="M17 15v7"></path></svg>;
        const Zap = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>;
        const Coffee = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>;
        const HomeIcon = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>;
        const Plane = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-1-3 0.5-4.5 2L11 8 2.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3.5L4.5 17c-.3.3-.5.7-.5 1.2s.2.9.5 1.2l.5.3c.4.2.8.1 1.1-.3l3.5-2 3.5 2 2-3.5 2.5 2.5c.4.4.8.5 1.2.5s.9-.2 1.2-.5l.3-.5c.1-.4-.1-.8-.5-1.1z"></path></svg>;
        const BookOpen = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>;
        const Clock = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
        const AlertCircle = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;
        const Download = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;
        const Send = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>;
        const Play = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
        const RotateCcw = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.76 2.75L3 8"></path><path d="M3 3v5h5"></path></svg>;
        const Award = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg>;
        const LogIn = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>;
        const UserPlus = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>;
        const LogOut = ({ size, className }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="17 16 22 12 17 8"></polyline><line x1="22" y1="12" x2="10" y2="12"></line></svg>;


        // Konteks untuk Mode Gelap dan Autentikasi
        const AppContext = createContext();

        const AppProvider = ({ children }) => {
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [showAuthModal, setShowAuthModal] = useState(false);

            // Inisialisasi Firebase dan penanganan autentikasi
            useEffect(() => {
                const appId = window.__app_id;
                const firebaseConfig = window.__firebase_config;

                try {
                    const app = initializeApp(firebaseConfig);
                    const authInstance = getAuth(app);
                    const firestoreInstance = getFirestore(app);

                    setAuth(authInstance);
                    setDb(firestoreInstance);

                    const unsubscribe = onAuthStateChanged(authInstance, async (currentUser) => {
                        if (currentUser) {
                            setUser(currentUser);
                            setUserId(currentUser.uid);
                            setIsAuthReady(true);
                        } else {
                            // Coba masuk dengan token kustom jika tersedia, jika tidak, masuk secara anonim
                            if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                                try {
                                    await signInWithCustomToken(authInstance, window.__initial_auth_token);
                                } catch (error) {
                                    console.error("Gagal masuk dengan token kustom:", error);
                                    // Jika token kustom gagal, coba masuk anonim
                                    await signInAnonymously(authInstance);
                                }
                            } else {
                                // Jika tidak ada token kustom, masuk anonim
                                await signInAnonymously(authInstance);
                            }
                        }
                    });
                    return () => unsubscribe();
                } catch (error) {
                    console.error("Gagal menginisialisasi Firebase:", error);
                    // Tampilkan modal kesalahan atau pesan kepada pengguna
                    setShowAuthModal(true);
                }
            }, []);

            const toggleDarkMode = () => {
                setIsDarkMode(prevMode => !prevMode);
                document.documentElement.classList.toggle('dark', !isDarkMode);
            };

            return (
                <AppContext.Provider value={{ isDarkMode, toggleDarkMode, user, db, auth, userId, isAuthReady, showAuthModal, setShowAuthModal, setUser }}>
                    {children}
                </AppContext.Provider>
            );
        };

        // Komponen Modal Kustom
        const CustomModal = ({ show, title, message, onClose, children }) => {
            if (!show) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-semibold text-gray-900 dark:text-white">{title}</h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <X size={24} />
                            </button>
                        </div>
                        <p className="text-gray-700 dark:text-gray-300 mb-4">{message}</p>
                        {children}
                        <div className="flex justify-end">
                            <button
                                onClick={onClose}
                                className="bg-gradient-to-r from-purple-400 to-pink-500 text-white px-4 py-2 rounded-full shadow-md hover:from-purple-500 hover:to-pink-600 transition-all duration-300"
                            >
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Komponen Notifikasi Pesan
        const NotificationMessage = ({ message, type }) => {
            if (!message) return null;
            const bgColor = type === 'success' ? 'bg-green-100 dark:bg-green-900' : type === 'error' ? 'bg-red-100 dark:bg-red-900' : 'bg-blue-100 dark:bg-blue-900';
            const textColor = type === 'success' ? 'text-green-700 dark:text-green-200' : type === 'error' ? 'text-red-700 dark:text-red-200' : 'text-blue-700 dark:text-blue-200';
            return (
                <div className={`p-3 rounded-lg text-sm mb-4 ${bgColor} ${textColor}`}>
                    {message}
                </div>
            );
        };

        // Komponen Navigasi Samping (Sidebar)
        const Sidebar = ({ isOpen, toggleSidebar, navigate }) => {
            const { isDarkMode, toggleDarkMode, userId, auth, setUser } = useContext(AppContext);

            const navItems = [
                { name: 'Dashboard', icon: Home, page: 'dashboard' },
                { name: 'Tambah Transaksi', icon: Plus, page: 'addTransaction' },
                { name: 'Perencanaan Anggaran', icon: BarChart2, page: 'budgetSetup' },
                { name: 'Tujuan Tabungan', icon: Target, page: 'savingsTracker' },
                { name: 'Daftar Keinginan', icon: Gift, page: 'wishlist' },
                { name: 'Kalender Pasangan', icon: Calendar, page: 'coupleCalendar' },
                { name: 'Pelacak Kebiasaan', icon: CheckSquare, page: 'habitTracker' },
                { name: 'Buku Harian', icon: Book, page: 'diary' },
                { name: 'Notifikasi', icon: Bell, page: 'notifications' },
                { name: 'Permainan', icon: Play, page: 'games' },
                { name: 'Pengaturan', icon: Settings, page: 'settings' },
            ];

            const handleLogout = async () => {
                if (auth) {
                    try {
                        await signOut(auth);
                        setUser(null);
                        navigate('login'); // Kembali ke halaman login setelah logout
                        toggleSidebar();
                    } catch (error) {
                        console.error("Gagal logout:", error);
                    }
                }
            };

            return (
                <div
                    className={`fixed inset-y-0 left-0 w-64 bg-white dark:bg-gray-800 shadow-lg transform ${isOpen ? 'translate-x-0' : '-translate-x-full'} transition-transform duration-300 ease-in-out z-40 p-4 flex flex-col`}
                >
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-900 dark:text-white">LuDesTrack</h2>
                        <button onClick={toggleSidebar} className="text-gray-600 dark:text-gray-300">
                            <X size={28} />
                        </button>
                    </div>

                    <div className="flex-grow">
                        {navItems.map((item) => (
                            <button
                                key={item.name}
                                onClick={() => { navigate(item.page); toggleSidebar(); }}
                                className="flex items-center w-full p-3 rounded-lg text-gray-700 dark:text-gray-200 hover:bg-purple-100 dark:hover:bg-gray-700 transition-colors duration-200 mb-2"
                            >
                                <item.icon size={20} className="mr-3" />
                                <span className="font-medium">{item.name}</span>
                            </button>
                        ))}
                    </div>

                    <div className="mt-auto pt-4 border-t border-gray-200 dark:border-gray-700">
                        <div className="flex items-center justify-between p-3 rounded-lg bg-gray-50 dark:bg-gray-700 mb-4">
                            <span className="text-gray-700 dark:text-gray-200 font-medium">Mode Gelap</span>
                            <button
                                onClick={toggleDarkMode}
                                className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 ${isDarkMode ? 'bg-purple-600' : 'bg-gray-200'}`}
                            >
                                <span
                                    className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 ${isDarkMode ? 'translate-x-6' : 'translate-x-1'}`}
                                ></span>
                            </button>
                        </div>
                        {userId && (
                            <div className="text-sm text-gray-500 dark:text-gray-400 text-center mb-2">
                                ID Pengguna: <span className="font-mono break-all">{userId}</span>
                            </div>
                        )}
                        <button
                            onClick={handleLogout}
                            className="w-full flex items-center justify-center bg-red-500 text-white py-2 rounded-full font-bold shadow-md hover:bg-red-600 transition-all duration-300"
                        >
                            <LogOut size={20} className="mr-2" /> Logout
                        </button>
                    </div>
                </div>
            );
        };

        // Komponen Header Aplikasi
        const AppHeader = ({ toggleSidebar, title }) => {
            return (
                <header className="flex items-center justify-between p-4 bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-30">
                    <button onClick={toggleSidebar} className="text-gray-600 dark:text-gray-300">
                        <Menu size={28} />
                    </button>
                    <h1 className="text-xl font-semibold text-gray-900 dark:text-white">{title}</h1>
                    <div className="flex items-center space-x-2">
                        <div className="w-8 h-8 bg-pink-300 rounded-full flex items-center justify-center text-white font-bold text-sm">L</div>
                        <div className="w-8 h-8 bg-blue-300 rounded-full flex items-center justify-center text-white font-bold text-sm">D</div>
                    </div>
                </header>
            );
        };

        // Komponen Kartu Informasi Generik (Score Card)
        const InfoCard = ({ title, value, icon: Icon, colorClass, bgColorClass }) => (
            <div className={`p-4 rounded-xl shadow-md flex items-center space-x-4 ${bgColorClass}`}>
                <div className={`p-3 rounded-full ${colorClass} bg-opacity-20`}>
                    <Icon size={24} className={colorClass} />
                </div>
                <div>
                    <p className="text-sm font-medium text-gray-600 dark:text-gray-300">{title}</p>
                    <p className="text-xl font-bold text-gray-900 dark:text-white">{value}</p>
                </div>
            </div>
        );

        // Komponen Dasbor
        const DashboardScreen = () => {
            const { db, userId, isAuthReady } = useContext(AppContext);
            const [transactions, setTransactions] = useState([]);
            const [budgets, setBudgets] = useState([]);
            const [savingsGoals, setSavingsGoals] = useState([]);
            const [showIndividualSummary, setShowIndividualSummary] = useState(false); // State untuk ringkasan individu

            useEffect(() => {
                if (!isAuthReady || !db || !userId) return;

                const fetchTransactions = onSnapshot(
                    query(collection(db, `artifacts/${window.__app_id}/users/${userId}/transactions`)),
                    (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setTransactions(data);
                    },
                    (error) => console.error("Gagal mengambil transaksi:", error)
                );

                const fetchBudgets = onSnapshot(
                    query(collection(db, `artifacts/${window.__app_id}/users/${userId}/budgets`)),
                    (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setBudgets(data);
                    },
                    (error) => console.error("Gagal mengambil anggaran:", error)
                );

                const fetchSavingsGoals = onSnapshot(
                    query(collection(db, `artifacts/${window.__app_id}/users/${userId}/savingsGoals`)),
                    (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setSavingsGoals(data);
                    },
                    (error) => console.error("Gagal mengambil tujuan tabungan:", error)
                );

                return () => {
                    fetchTransactions();
                    fetchBudgets();
                    fetchSavingsGoals();
                };
            }, [db, userId, isAuthReady]);

            // Logika perhitungan
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const currentSavings = savingsGoals.reduce((sum, goal) => sum + goal.currentAmount, 0);
            const totalBudget = budgets.reduce((sum, b) => sum + b.amount, 0);
            const budgetSpent = budgets.reduce((sum, b) => sum + b.currentSpent, 0);

            // Data untuk grafik pie (pengeluaran pribadi vs bersama) - placeholder
            // Untuk implementasi nyata, transaksi perlu ditandai sebagai 'pribadi' atau 'bersama'
            const personalVsSharedData = [
                { name: 'Pribadi', value: totalExpenses * 0.6 }, // Contoh 60% pribadi
                { name: 'Bersama', value: totalExpenses * 0.4 }, // Contoh 40% bersama
            ];
            const COLORS_PERSONAL_SHARED = ['#8884d8', '#82ca9d']; // Warna untuk pribadi vs bersama

            // Data untuk grafik pie (pengeluaran berdasarkan kategori)
            const expenseCategories = transactions
                .filter(t => t.type === 'expense')
                .reduce((acc, t) => {
                    acc[t.category] = (acc[t.category] || 0) + t.amount;
                    return acc;
                }, {});

            const categoryPieData = Object.entries(expenseCategories).map(([name, value]) => ({ name, value }));
            const COLORS_CATEGORIES = ['#FF6B6B', '#FFD166', '#06D6A0', '#118AB2', '#073B4C', '#A8DADC', '#457B9D', '#E63946'];

            // Data untuk grafik batang (Ikhtisar Bulanan)
            const monthlyData = [
                { name: 'Jan', income: 4000, expenses: 2400 },
                { name: 'Feb', income: 3000, expenses: 1398 },
                { name: 'Mar', income: 2000, expenses: 9800 },
                { name: 'Apr', income: 2780, expenses: 3908 },
                { name: 'Mei', income: 1890, expenses: 4800 },
                { name: 'Jun', income: 2390, expenses: 3800 },
                { name: 'Jul', income: 3490, expenses: 4300 },
            ];

            // Data placeholder untuk ringkasan individu
            const lukmanSummary = { income: 2500, expenses: 1500, savings: 500 };
            const destrySummary = { income: 2000, expenses: 1200, savings: 400 };

            return (
                <div className="p-4 space-y-6 bg-gray-50 dark:bg-gray-900 min-h-screen">
                    {/* Kartu Saldo (Score Cards) */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <InfoCard
                            title="Total Pemasukan"
                            value={`Rp ${totalIncome.toLocaleString('id-ID')}`}
                            icon={TrendingUp}
                            colorClass="text-green-500"
                            bgColorClass="bg-green-50 dark:bg-gray-800"
                        />
                        <InfoCard
                            title="Total Pengeluaran"
                            value={`Rp ${totalExpenses.toLocaleString('id-ID')}`}
                            icon={TrendingDown}
                            colorClass="text-red-500"
                            bgColorClass="bg-red-50 dark:bg-gray-800"
                        />
                        <InfoCard
                            title="Tabungan Saat Ini"
                            value={`Rp ${currentSavings.toLocaleString('id-ID')}`}
                            icon={Save}
                            colorClass="text-blue-500"
                            bgColorClass="bg-blue-50 dark:bg-gray-800"
                        />
                    </div>

                    {/* Toggle Ringkasan Individu */}
                    <div className="flex justify-center items-center bg-white dark:bg-gray-800 rounded-xl shadow-md p-3">
                        <span className="text-gray-700 dark:text-gray-300 mr-3">Tampilkan Ringkasan Individu:</span>
                        <button
                            onClick={() => setShowIndividualSummary(!showIndividualSummary)}
                            className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 ${showIndividualSummary ? 'bg-purple-600' : 'bg-gray-200'}`}
                        >
                            <span
                                className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 ${showIndividualSummary ? 'translate-x-6' : 'translate-x-1'}`}
                            ></span>
                        </button>
                    </div>

                    {showIndividualSummary && (
                        <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4">
                            <h3 className="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Ringkasan Per Individu (Contoh)</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="p-4 rounded-lg bg-pink-50 dark:bg-gray-700 shadow-sm">
                                    <h4 className="font-semibold text-pink-700 dark:text-pink-300 mb-2">Lukman</h4>
                                    <p className="text-gray-700 dark:text-gray-300">Pemasukan: Rp {lukmanSummary.income.toLocaleString('id-ID')}</p>
                                    <p className="text-gray-700 dark:text-gray-300">Pengeluaran: Rp {lukmanSummary.expenses.toLocaleString('id-ID')}</p>
                                    <p className="text-gray-700 dark:text-gray-300">Tabungan: Rp {lukmanSummary.savings.toLocaleString('id-ID')}</p>
                                </div>
                                <div className="p-4 rounded-lg bg-blue-50 dark:bg-gray-700 shadow-sm">
                                    <h4 className="font-semibold text-blue-700 dark:text-blue-300 mb-2">Destry</h4>
                                    <p className="text-gray-700 dark:text-gray-300">Pemasukan: Rp {destrySummary.income.toLocaleString('id-ID')}</p>
                                    <p className="text-gray-700 dark:text-gray-300">Pengeluaran: Rp {destrySummary.expenses.toLocaleString('id-ID')}</p>
                                    <p className="text-gray-700 dark:text-gray-300">Tabungan: Rp {destrySummary.savings.toLocaleString('id-ID')}</p>
                                </div>
                            </div>
                            <p className="text-sm text-gray-500 dark:text-gray-400 mt-4">
                                *Catatan: Data ini adalah contoh. Untuk ringkasan individu yang akurat, transaksi perlu ditandai dengan pengguna yang sesuai.
                            </p>
                        </div>
                    )}


                    {/* Grafik Batang Ikhtisar Bulanan */}
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4">
                        <h3 className="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Ikhtisar Bulanan</h3>
                        <ResponsiveContainer width="100%" height={250}>
                            <BarChart data={monthlyData}>
                                <XAxis dataKey="name" stroke={useContext(AppContext).isDarkMode ? '#9ca3af' : '#6b7280'} />
                                <YAxis stroke={useContext(AppContext).isDarkMode ? '#9ca3af' : '#6b7280'} />
                                <Tooltip
                                    contentStyle={{ backgroundColor: useContext(AppContext).isDarkMode ? '#374151' : '#ffffff', border: 'none', borderRadius: '8px' }}
                                    itemStyle={{ color: useContext(AppContext).isDarkMode ? '#e5e7eb' : '#1f2937' }}
                                />
                                <Bar dataKey="income" fill="#82ca9d" name="Pemasukan" radius={[5, 5, 0, 0]} />
                                <Bar dataKey="expenses" fill="#8884d8" name="Pengeluaran" radius={[5, 5, 0, 0]} />
                            </BarChart>
                        </ResponsiveContainer>
                    </div>

                    {/* Grafik Donat Pengeluaran Pribadi vs Bersama */}
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4">
                        <h3 className="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Pengeluaran Pribadi vs Bersama</h3>
                        <ResponsiveContainer width="100%" height={250}>
                            <PieChart>
                                <Pie
                                    data={personalVsSharedData}
                                    cx="50%"
                                    cy="50%"
                                    innerRadius={60}
                                    outerRadius={80}
                                    fill="#8884d8"
                                    paddingAngle={5}
                                    dataKey="value"
                                    label
                                >
                                    {personalVsSharedData.map((entry, index) => (
                                        <Cell key={`cell-${index}`} fill={COLORS_PERSONAL_SHARED[index % COLORS_PERSONAL_SHARED.length]} />
                                    ))}
                                </Pie>
                                <Tooltip
                                    contentStyle={{ backgroundColor: useContext(AppContext).isDarkMode ? '#374151' : '#ffffff', border: 'none', borderRadius: '8px' }}
                                    itemStyle={{ color: useContext(AppContext).isDarkMode ? '#e5e7eb' : '#1f2937' }}
                                />
                            </PieChart>
                        </ResponsiveContainer>
                        <div className="flex justify-center mt-4 space-x-4">
                            {personalVsSharedData.map((entry, index) => (
                                <div key={`legend-${index}`} className="flex items-center">
                                    <span className="inline-block w-3 h-3 rounded-full mr-2" style={{ backgroundColor: COLORS_PERSONAL_SHARED[index % COLORS_PERSONAL_SHARED.length] }}></span>
                                    <span className="text-sm text-gray-700 dark:text-gray-300">{entry.name}</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Grafik Pie Pengeluaran Berdasarkan Kategori */}
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-4">
                        <h3 className="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Pengeluaran Berdasarkan Kategori</h3>
                        <ResponsiveContainer width="100%" height={250}>
                            <PieChart>
                                <Pie
                                    data={categoryPieData}
                                    cx="50%"
                                    cy="50%"
                                    outerRadius={80}
                                    fill="#8884d8"
                                    dataKey="value"
                                    label
                                >
                                    {categoryPieData.map((entry, index) => (
                                        <Cell key={`cell-${index}`} fill={COLORS_CATEGORIES[index % COLORS_CATEGORIES.length]} />
                                    ))}
                                </Pie>
                                <Tooltip
                                    contentStyle={{ backgroundColor: useContext(AppContext).isDarkMode ? '#374151' : '#ffffff', border: 'none', borderRadius: '8px' }}
                                    itemStyle={{ color: useContext(AppContext).isDarkMode ? '#e5e7eb' : '#1f2937' }}
                                />
                            </PieChart>
                        </ResponsiveContainer>
                        <div className="flex flex-wrap justify-center mt-4 gap-4">
                            {categoryPieData.map((entry, index) => (
                                <div key={`legend-${index}`} className="flex items-center">
                                    <span className="inline-block w-3 h-3 rounded-full mr-2" style={{ backgroundColor: COLORS_CATEGORIES[index % COLORS_CATEGORIES.length] }}></span>
                                    <span className="text-sm text-gray-700 dark:text-gray-300">{entry.name}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // Komponen Tambah Transaksi
        const AddTransactionScreen = () => {
            const { db, userId, isAuthReady } = useContext(AppContext);
            const [amount, setAmount] = useState('');
            const [type, setType] = useState('expense'); // 'income' or 'expense'
            const [category, setCategory] = useState('');
            const [description, setDescription] = useState('');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [receiptImage, setReceiptImage] = useState(null);
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');

            const expenseCategories = ['Makanan', 'Tagihan', 'Hiburan', 'Transportasi', 'Belanja', 'Lain-lain'];
            const incomeCategories = ['Gaji', 'Bonus', 'Investasi', 'Hadiah', 'Lain-lain'];

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Dalam aplikasi nyata, Anda akan mengunggah ini ke penyimpanan cloud (misalnya Firebase Storage)
                    // Untuk demo UI, kita hanya akan menyimpan URL objek sementara
                    setReceiptImage(URL.createObjectURL(file));
                    setMessage('Gambar tanda terima berhasil dipilih!');
                    setMessageType('success');
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!db || !userId || !isAuthReady) {
                    setMessage('Autentikasi belum siap. Silakan coba lagi.');
                    setMessageType('error');
                    return;
                }
                if (!amount || !category || !description || !date) {
                    setMessage('Harap isi semua bidang yang wajib diisi.');
                    setMessageType('error');
                    return;
                }

                try {
                    await addDoc(collection(db, `artifacts/${window.__app_id}/users/${userId}/transactions`), {
                        amount: parseFloat(amount),
                        type,
                        category,
                        description,
                        date: new Date(date),
                        receiptImageUrl: receiptImage, // Ini hanya URL objek sementara untuk demo
                        createdAt: new Date(),
                    });
                    setMessage('Transaksi berhasil ditambahkan!');
                    setMessageType('success');
                    setAmount('');
                    setCategory('');
                    setDescription('');
                    setDate(new Date().toISOString().split('T')[0]);
                    setReceiptImage(null);
                } catch (error) {
                    console.error("Kesalahan menambahkan transaksi:", error);
                    setMessage('Gagal menambahkan transaksi. Silakan coba lagi.');
                    setMessageType('error');
                }
            };

            return (
                <div className="p-4 bg-gray-50 dark:bg-gray-900 min-h-screen">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                        <h2 className="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Tambah Transaksi</h2>

                        <NotificationMessage message={message} type={messageType} />

                        <form onSubmit={handleSubmit} className="space-y-5">
                            <div>
                                <label className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Jenis Transaksi</label>
                                <div className="flex space-x-4">
                                    <button
                                        type="button"
                                        onClick={() => setType('income')}
                                        className={`flex-1 py-3 rounded-lg font-semibold transition-colors duration-200 ${type === 'income' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300'}`}
                                    >
                                        Pemasukan
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setType('expense')}
                                        className={`flex-1 py-3 rounded-lg font-semibold transition-colors duration-200 ${type === 'expense' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300'}`}
                                    >
                                        Pengeluaran
                                    </button>
                                </div>
                            </div>

                            <div>
                                <label htmlFor="amount" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Jumlah (Rp)</label>
                                <input
                                    type="number"
                                    id="amount"
                                    value={amount}
                                    onChange={(e) => setAmount(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    placeholder="Contoh: 500000"
                                    required
                                />
                            </div>

                            <div>
                                <label htmlFor="category" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Kategori</label>
                                <select
                                    id="category"
                                    value={category}
                                    onChange={(e) => setCategory(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    required
                                >
                                    <option value="">Pilih Kategori</option>
                                    {(type === 'expense' ? expenseCategories : incomeCategories).map((cat) => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                            </div>

                            <div>
                                <label htmlFor="description" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Deskripsi</label>
                                <textarea
                                    id="description"
                                    value={description}
                                    onChange={(e) => setDescription(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    placeholder="Contoh: Makan malam di restoran"
                                    rows="3"
                                    required
                                ></textarea>
                            </div>

                            <div>
                                <label htmlFor="date" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Tanggal</label>
                                <input
                                    type="date"
                                    id="date"
                                    value={date}
                                    onChange={(e) => setDate(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    required
                                />
                            </div>

                            <div>
                                <label htmlFor="receipt" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Unggah Tanda Terima (Opsional)</label>
                                <input
                                    type="file"
                                    id="receipt"
                                    accept="image/*"
                                    onChange={handleImageUpload}
                                    className="w-full text-gray-700 dark:text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"
                                />
                                {receiptImage && (
                                    <img src={receiptImage} alt="Pratinjau Tanda Terima" className="mt-4 w-32 h-32 object-cover rounded-lg shadow-md" />
                                )}
                            </div>

                            <button
                                type="submit"
                                className="w-full bg-gradient-to-r from-purple-400 to-pink-500 text-white py-3 rounded-full font-bold shadow-lg hover:from-purple-500 hover:to-pink-600 transition-all duration-300"
                            >
                                Tambah Transaksi
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        // Komponen Pengaturan Anggaran
        const BudgetSetupScreen = () => {
            const { db, userId, isAuthReady } = useContext(AppContext);
            const [budgets, setBudgets] = useState([]);
            const [newCategory, setNewCategory] = useState('');
            const [newAmount, setNewAmount] = useState('');
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');

            useEffect(() => {
                if (!isAuthReady || !db || !userId) return;

                const unsubscribe = onSnapshot(
                    query(collection(db, `artifacts/${window.__app_id}/users/${userId}/budgets`)),
                    (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setBudgets(data);
                    },
                    (error) => console.error("Gagal mengambil anggaran:", error)
                );

                return () => unsubscribe();
            }, [db, userId, isAuthReady]);

            const handleAddBudget = async (e) => {
                e.preventDefault();
                if (!db || !userId || !isAuthReady) {
                    setMessage('Autentikasi belum siap. Silakan coba lagi.');
                    setMessageType('error');
                    return;
                }
                if (!newCategory || !newAmount) {
                    setMessage('Harap isi kategori dan jumlah.');
                    setMessageType('error');
                    return;
                }

                try {
                    await addDoc(collection(db, `artifacts/${window.__app_id}/users/${userId}/budgets`), {
                        category: newCategory,
                        amount: parseFloat(newAmount),
                        currentSpent: 0, // Inisialisasi pengeluaran saat ini
                        createdAt: new Date(),
                    });
                    setMessage('Anggaran berhasil ditambahkan!');
                    setMessageType('success');
                    setNewCategory('');
                    setNewAmount('');
                } catch (error) {
                    console.error("Kesalahan menambahkan anggaran:", error);
                    setMessage('Gagal menambahkan anggaran. Silakan coba lagi.');
                    setMessageType('error');
                }
            };

            const handleUpdateSpent = async (id, amountToAdd) => {
                if (!db || !userId || !isAuthReady) return;
                try {
                    const budgetRef = doc(db, `artifacts/${window.__app_id}/users/${userId}/budgets`, id);
                    const budgetSnap = await getDoc(budgetRef);
                    if (budgetSnap.exists()) {
                        const currentSpent = budgetSnap.data().currentSpent || 0;
                        await updateDoc(budgetRef, {
                            currentSpent: currentSpent + parseFloat(amountToAdd),
                        });
                        setMessage('Pengeluaran anggaran berhasil diperbarui!');
                        setMessageType('success');
                    }
                } catch (error) {
                    console.error("Kesalahan memperbarui pengeluaran anggaran:", error);
                    setMessage('Gagal memperbarui pengeluaran anggaran.');
                    setMessageType('error');
                }
            };

            const handleDeleteBudget = async (id) => {
                if (!db || !userId || !isAuthReady) return;
                try {
                    await deleteDoc(doc(db, `artifacts/${window.__app_id}/users/${userId}/budgets`, id));
                    setMessage('Anggaran berhasil dihapus!');
                    setMessageType('success');
                } catch (error) {
                    console.error("Kesalahan menghapus anggaran:", error);
                    setMessage('Gagal menghapus anggaran.');
                    setMessageType('error');
                }
            };

            return (
                <div className="p-4 bg-gray-50 dark:bg-gray-900 min-h-screen">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-6">
                        <h2 className="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Perencanaan Anggaran</h2>

                        <NotificationMessage message={message} type={messageType} />

                        <form onSubmit={handleAddBudget} className="space-y-4 mb-6">
                            <div>
                                <label htmlFor="newCategory" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Kategori Baru</label>
                                <input
                                    type="text"
                                    id="newCategory"
                                    value={newCategory}
                                    onChange={(e) => setNewCategory(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    placeholder="Contoh: Transportasi"
                                    required
                                />
                            </div>
                            <div>
                                <label htmlFor="newAmount" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Jumlah Anggaran (Rp)</label>
                                <input
                                    type="number"
                                    id="newAmount"
                                    value={newAmount}
                                    onChange={(e) => setNewAmount(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    placeholder="Contoh: 1000000"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                className="w-full bg-gradient-to-r from-purple-400 to-pink-500 text-white py-3 rounded-full font-bold shadow-lg hover:from-purple-500 hover:to-pink-600 transition-all duration-300"
                            >
                                Tambah Anggaran
                            </button>
                        </form>

                        <h3 className="text-xl font-bold mb-4 text-gray-900 dark:text-white">Anggaran Anda</h3>
                        <div className="space-y-4">
                            {budgets.length === 0 ? (
                                <p className="text-gray-600 dark:text-gray-400">Belum ada anggaran yang diatur.</p>
                            ) : (
                                budgets.map((budget) => {
                                    const percentage = (budget.currentSpent / budget.amount) * 100;
                                    const isExceeded = percentage > 100;
                                    return (
                                        <div key={budget.id} className="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl shadow-sm">
                                            <div className="flex justify-between items-center mb-2">
                                                <h4 className="text-lg font-semibold text-gray-900 dark:text-white">{budget.category}</h4>
                                                <button onClick={() => handleDeleteBudget(budget.id)} className="text-red-500 hover:text-red-700">
                                                    <X size={20} />
                                                </button>
                                            </div>
                                            <p className="text-sm text-gray-600 dark:text-gray-400">Anggaran: Rp {budget.amount.toLocaleString('id-ID')}</p>
                                            <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">Terpakai: Rp {budget.currentSpent.toLocaleString('id-ID')}</p>
                                            <div className="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-600">
                                                <div
                                                    className={`h-2.5 rounded-full ${isExceeded ? 'bg-red-500' : 'bg-purple-500'}`}
                                                    style={{ width: `${Math.min(percentage, 100)}%` }}
                                                ></div>
                                            </div>
                                            {isExceeded && (
                                                <p className="text-red-500 text-sm mt-2 flex items-center">
                                                    <AlertCircle size={16} className="mr-1" /> Batas terlampaui!
                                                </p>
                                            )}
                                            <div className="mt-3 flex items-center space-x-2" id={`budget-item-${budget.id}`}>
                                                <input
                                                    type="number"
                                                    placeholder="Tambah pengeluaran"
                                                    className="flex-grow p-2 border border-gray-300 rounded-lg text-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                                                    onKeyDown={(e) => {
                                                        if (e.key === 'Enter' && e.target.value) {
                                                            handleUpdateSpent(budget.id, parseFloat(e.target.value));
                                                            e.target.value = '';
                                                        }
                                                    }}
                                                />
                                                <button
                                                    onClick={() => {
                                                        const inputElement = document.querySelector(`#budget-item-${budget.id} input`);
                                                        if (inputElement && inputElement.value) {
                                                            handleUpdateSpent(budget.id, parseFloat(inputElement.value));
                                                            inputElement.value = '';
                                                        }
                                                    }}
                                                    className="bg-purple-500 text-white p-2 rounded-lg text-sm hover:bg-purple-600 transition-colors"
                                                >
                                                    Perbarui
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Komponen Pelacak Tabungan
        const SavingsTrackerScreen = () => {
            const { db, userId, isAuthReady } = useContext(AppContext);
            const [savingsGoals, setSavingsGoals] = useState([]);
            const [newGoalName, setNewGoalName] = useState('');
            const [newGoalTarget, setNewGoalTarget] = useState('');
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');

            useEffect(() => {
                if (!isAuthReady || !db || !userId) return;

                const unsubscribe = onSnapshot(
                    query(collection(db, `artifacts/${window.__app_id}/users/${userId}/savingsGoals`)),
                    (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setSavingsGoals(data);
                    },
                    (error) => console.error("Gagal mengambil tujuan tabungan:", error)
                );

                return () => unsubscribe();
            }, [db, userId, isAuthReady]);

            const handleAddGoal = async (e) => {
                e.preventDefault();
                if (!db || !userId || !isAuthReady) {
                    setMessage('Autentikasi belum siap. Silakan coba lagi.');
                    setMessageType('error');
                    return;
                }
                if (!newGoalName || !newGoalTarget) {
                    setMessage('Harap isi nama tujuan dan target jumlah.');
                    setMessageType('error');
                    return;
                }

                try {
                    await addDoc(collection(db, `artifacts/${window.__app_id}/users/${userId}/savingsGoals`), {
                        name: newGoalName,
                        targetAmount: parseFloat(newGoalTarget),
                        currentAmount: 0,
                        notes: '',
                        createdAt: new Date(),
                    });
                    setMessage('Tujuan tabungan berhasil ditambahkan!');
                    setMessageType('success');
                    setNewGoalName('');
                    setNewGoalTarget('');
                } catch (error) {
                    console.error("Kesalahan menambahkan tujuan tabungan:", error);
                    setMessage('Gagal menambahkan tujuan tabungan. Silakan coba lagi.');
                    setMessageType('error');
                }
            };

            const handleUpdateAmount = async (id, amountToAdd) => {
                if (!db || !userId || !isAuthReady) return;
                try {
                    const goalRef = doc(db, `artifacts/${window.__app_id}/users/${userId}/savingsGoals`, id);
                    const goalSnap = await getDoc(goalRef);
                    if (goalSnap.exists()) {
                        const currentAmount = goalSnap.data().currentAmount || 0;
                        await updateDoc(goalRef, {
                            currentAmount: currentAmount + parseFloat(amountToAdd),
                        });
                        setMessage('Jumlah tabungan berhasil diperbarui!');
                        setMessageType('success');
                    }
                } catch (error) {
                    console.error("Kesalahan memperbarui jumlah tabungan:", error);
                    setMessage('Gagal memperbarui jumlah tabungan.');
                    setMessageType('error');
                }
            };

            const handleUpdateNotes = async (id, notes) => {
                if (!db || !userId || !isAuthReady) return;
                try {
                    await updateDoc(doc(db, `artifacts/${window.__app_id}/users/${userId}/savingsGoals`, id), {
                        notes: notes,
                    });
                    setMessage('Catatan tabungan berhasil diperbarui!');
                    setMessageType('success');
                } catch (error) {
                    console.error("Kesalahan memperbarui catatan tabungan:", error);
                    setMessage('Gagal memperbarui catatan tabungan.');
                    setMessageType('error');
                }
            };

            const handleDeleteGoal = async (id) => {
                if (!db || !userId || !isAuthReady) return;
                try {
                    await deleteDoc(doc(db, `artifacts/${window.__app_id}/users/${userId}/savingsGoals`, id));
                    setMessage('Tujuan tabungan berhasil dihapus!');
                    setMessageType('success');
                } catch (error) {
                    console.error("Kesalahan menghapus tujuan tabungan:", error);
                    setMessage('Gagal menghapus tujuan tabungan.');
                    setMessageType('error');
                }
            };

            const totalCurrentSavings = savingsGoals.reduce((sum, goal) => sum + goal.currentAmount, 0);

            return (
                <div className="p-4 bg-gray-50 dark:bg-gray-900 min-h-screen">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-6">
                        <h2 className="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Tujuan Tabungan</h2>

                        <NotificationMessage message={message} type={messageType} />

                        {/* Kartu Skor Total Tabungan */}
                        <InfoCard
                            title="Total Tabungan Semua Tujuan"
                            value={`Rp ${totalCurrentSavings.toLocaleString('id-ID')}`}
                            icon={Save}
                            colorClass="text-blue-500"
                            bgColorClass="bg-blue-50 dark:bg-gray-800 mb-6"
                        />

                        <form onSubmit={handleAddGoal} className="space-y-4 mb-6">
                            <div>
                                <label htmlFor="newGoalName" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Nama Tujuan</label>
                                <input
                                    type="text"
                                    id="newGoalName"
                                    value={newGoalName}
                                    onChange={(e) => setNewGoalName(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    placeholder="Contoh: Uang Muka Rumah"
                                    required
                                />
                            </div>
                            <div>
                                <label htmlFor="newGoalTarget" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Target Jumlah (Rp)</label>
                                <input
                                    type="number"
                                    id="newGoalTarget"
                                    value={newGoalTarget}
                                    onChange={(e) => setNewGoalTarget(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    placeholder="Contoh: 50000000"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                className="w-full bg-gradient-to-r from-purple-400 to-pink-500 text-white py-3 rounded-full font-bold shadow-lg hover:from-purple-500 hover:to-pink-600 transition-all duration-300"
                            >
                                Tambah Tujuan
                            </button>
                        </form>

                        <h3 className="text-xl font-bold mb-4 text-gray-900 dark:text-white">Tujuan Anda</h3>
                        <div className="space-y-4">
                            {savingsGoals.length === 0 ? (
                                <p className="text-gray-600 dark:text-gray-400">Belum ada tujuan tabungan yang diatur.</p>
                            ) : (
                                savingsGoals.map((goal) => {
                                    const progress = (goal.currentAmount / goal.targetAmount) * 100;
                                    return (
                                        <div key={goal.id} className="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl shadow-sm">
                                            <div className="flex justify-between items-center mb-2">
                                                <h4 className="text-lg font-semibold text-gray-900 dark:text-white">{goal.name}</h4>
                                                <button onClick={() => handleDeleteGoal(goal.id)} className="text-red-500 hover:text-red-700">
                                                    <X size={20} />
                                                </button>
                                            </div>
                                            <p className="text-sm text-gray-600 dark:text-gray-400">Target: Rp {goal.targetAmount.toLocaleString('id-ID')}</p>
                                            <p className="text-sm text-gray-600 dark:text-gray-400 mb-2">Terkumpul: Rp {goal.currentAmount.toLocaleString('id-ID')}</p>
                                            <div className="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-600">
                                                <div
                                                    className="h-2.5 rounded-full bg-blue-500"
                                                    style={{ width: `${Math.min(progress, 100)}%` }}
                                                ></div>
                                            </div>
                                            <p className="text-sm text-gray-600 dark:text-gray-400 mt-2">{progress.toFixed(1)}% Tercapai</p>
                                            <div className="mt-3 flex items-center space-x-2" id={`savings-item-${goal.id}`}>
                                                <input
                                                    type="number"
                                                    placeholder="Tambah jumlah"
                                                    className="flex-grow p-2 border border-gray-300 rounded-lg text-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                                                    onKeyDown={(e) => {
                                                        if (e.key === 'Enter' && e.target.value) {
                                                            handleUpdateAmount(goal.id, parseFloat(e.target.value));
                                                            e.target.value = '';
                                                        }
                                                    }}
                                                />
                                                <button
                                                    onClick={() => {
                                                        const inputElement = document.querySelector(`#savings-item-${goal.id} input`);
                                                        if (inputElement && inputElement.value) {
                                                            handleUpdateAmount(goal.id, parseFloat(inputElement.value));
                                                            inputElement.value = '';
                                                        }
                                                    }}
                                                    className="bg-blue-500 text-white p-2 rounded-lg text-sm hover:bg-blue-600 transition-colors"
                                                >
                                                    Tambah
                                                </button>
                                            </div>
                                            <textarea
                                                className="w-full mt-3 p-2 border border-gray-300 rounded-lg text-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white"
                                                placeholder="Catatan bersama..."
                                                value={goal.notes}
                                                onChange={(e) => handleUpdateNotes(goal.id, e.target.value)}
                                                rows="2"
                                            ></textarea>
                                        </div>
                                    );
                                })
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Komponen Daftar Keinginan
        const WishlistScreen = () => {
            const { db, userId, isAuthReady } = useContext(AppContext);
            const [wishlistItems, setWishlistItems] = useState([]);
            const [title, setTitle] = useState('');
            const [price, setPrice] = useState('');
            const [imageUrl, setImageUrl] = useState('');
            const [priority, setPriority] = useState('Medium');
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');

            useEffect(() => {
                if (!isAuthReady || !db || !userId) return;

                const unsubscribe = onSnapshot(
                    query(collection(db, `artifacts/${window.__app_id}/public/data/wishlist`)), // Asumsi daftar keinginan publik/bersama
                    (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setWishlistItems(data);
                    },
                    (error) => console.error("Gagal mengambil daftar keinginan:", error)
                );

                return () => unsubscribe();
            }, [db, userId, isAuthReady]);

            const handleAddItem = async (e) => {
                e.preventDefault();
                if (!db || !userId || !isAuthReady) {
                    setMessage('Autentikasi belum siap. Silakan coba lagi.');
                    setMessageType('error');
                    return;
                }
                if (!title || !price) {
                    setMessage('Harap isi judul dan harga.');
                    setMessageType('error');
                    return;
                }

                try {
                    await addDoc(collection(db, `artifacts/${window.__app_id}/public/data/wishlist`), {
                        title,
                        price: parseFloat(price),
                        imageUrl: imageUrl || `https://placehold.co/100x100/A8DADC/073B4C?text=${title.substring(0, 3)}`,
                        priority,
                        status: 'Want', // Default status
                        createdAt: new Date(),
                        addedBy: userId, // Catat siapa yang menambahkan
                    });
                    setMessage('Item daftar keinginan berhasil ditambahkan!');
                    setMessageType('success');
                    setTitle('');
                    setPrice('');
                    setImageUrl('');
                    setPriority('Medium');
                } catch (error) {
                    console.error("Kesalahan menambahkan item daftar keinginan:", error);
                    setMessage('Gagal menambahkan item daftar keinginan. Silakan coba lagi.');
                    setMessageType('error');
                }
            };

            const handleUpdateStatus = async (id, newStatus) => {
                if (!db || !userId || !isAuthReady) return;
                try {
                    await updateDoc(doc(db, `artifacts/${window.__app_id}/public/data/wishlist`, id), {
                        status: newStatus,
                    });
                    setMessage('Status item daftar keinginan berhasil diperbarui!');
                    setMessageType('success');
                } catch (error) {
                    console.error("Kesalahan memperbarui status daftar keinginan:", error);
                    setMessage('Gagal memperbarui status daftar keinginan.');
                    setMessageType('error');
                }
            };

            const handleDeleteItem = async (id) => {
                if (!db || !userId || !isAuthReady) return;
                try {
                    await deleteDoc(doc(db, `artifacts/${window.__app_id}/public/data/wishlist`, id));
                    setMessage('Item daftar keinginan berhasil dihapus!');
                    setMessageType('success');
                } catch (error) {
                    console.error("Kesalahan menghapus item daftar keinginan:", error);
                    setMessage('Gagal menghapus item daftar keinginan.');
                    setMessageType('error');
                }
            };

            const getPriorityColor = (prio) => {
                switch (prio) {
                    case 'High': return 'bg-red-200 text-red-800';
                    case 'Medium': return 'bg-yellow-200 text-yellow-800';
                    case 'Low': return 'bg-green-200 text-green-800';
                    default: return 'bg-gray-200 text-gray-800';
                }
            };

            const getStatusColor = (status) => {
                switch (status) {
                    case 'Want': return 'bg-blue-200 text-blue-800';
                    case 'Planning': return 'bg-purple-200 text-purple-800';
                    case 'Purchased': return 'bg-green-200 text-green-800';
                    default: return 'bg-gray-200 text-gray-800';
                }
            };

            return (
                <div className="p-4 bg-gray-50 dark:bg-gray-900 min-h-screen">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-6">
                        <h2 className="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Daftar Keinginan Bersama</h2>

                        <NotificationMessage message={message} type={messageType} />

                        <form onSubmit={handleAddItem} className="space-y-4 mb-6">
                            <div>
                                <label htmlFor="title" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Judul Item</label>
                                <input
                                    type="text"
                                    id="title"
                                    value={title}
                                    onChange={(e) => setTitle(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    placeholder="Contoh: Laptop Baru"
                                    required
                                />
                            </div>
                            <div>
                                <label htmlFor="price" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Harga (Rp)</label>
                                <input
                                    type="number"
                                    id="price"
                                    value={price}
                                    onChange={(e) => setPrice(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    placeholder="Contoh: 12000000"
                                    required
                                />
                            </div>
                            <div>
                                <label htmlFor="imageUrl" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">URL Gambar (Opsional)</label>
                                <input
                                    type="text"
                                    id="imageUrl"
                                    value={imageUrl}
                                    onChange={(e) => setImageUrl(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    placeholder="https://example.com/image.jpg"
                                />
                            </div>
                            <div>
                                <label htmlFor="priority" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Prioritas</label>
                                <select
                                    id="priority"
                                    value={priority}
                                    onChange={(e) => setPriority(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                >
                                    <option value="Low">Rendah</option>
                                    <option value="Medium">Sedang</option>
                                    <option value="High">Tinggi</option>
                                </select>
                            </div>
                            <button
                                type="submit"
                                className="w-full bg-gradient-to-r from-purple-400 to-pink-500 text-white py-3 rounded-full font-bold shadow-lg hover:from-purple-500 hover:to-pink-600 transition-all duration-300"
                            >
                                Tambah Item
                            </button>
                        </form>

                        <h3 className="text-xl font-bold mb-4 text-gray-900 dark:text-white">Item Daftar Keinginan</h3>
                        <div className="space-y-4">
                            {wishlistItems.length === 0 ? (
                                <p className="text-gray-600 dark:text-gray-400">Daftar keinginan kosong.</p>
                            ) : (
                                wishlistItems.map((item) => (
                                    <div key={item.id} className="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl shadow-sm flex items-center space-x-4">
                                        <img src={item.imageUrl} alt={item.title} className="w-20 h-20 object-cover rounded-lg" onError={(e) => e.target.src = `https://placehold.co/100x100/A8DADC/073B4C?text=NoImg`} />
                                        <div className="flex-grow">
                                            <div className="flex justify-between items-start">
                                                <h4 className="text-lg font-semibold text-gray-900 dark:text-white">{item.title}</h4>
                                                <button onClick={() => handleDeleteItem(item.id)} className="text-red-500 hover:text-red-700">
                                                    <X size={20} />
                                                </button>
                                            </div>
                                            <p className="text-sm text-gray-600 dark:text-gray-400">Rp {item.price.toLocaleString('id-ID')}</p>
                                            <div className="flex items-center space-x-2 mt-1">
                                                <span className={`px-2 py-1 rounded-full text-xs font-medium ${getPriorityColor(item.priority)}`}>
                                                    {item.priority}
                                                </span>
                                                <select
                                                    value={item.status}
                                                    onChange={(e) => handleUpdateStatus(item.id, e.target.value)}
                                                    className={`px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(item.status)} dark:bg-opacity-50 dark:border-gray-600`}
                                                >
                                                    <option value="Want">Ingin</option>
                                                    <option value="Planning">Merencanakan</option>
                                                    <option value="Purchased">Dibeli</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Komponen Kalender Pasangan
        const CoupleCalendarScreen = () => {
            const { db, userId, isAuthReady } = useContext(AppContext);
            const [events, setEvents] = useState([]);
            const [newEventTitle, setNewEventTitle] = useState('');
            const [newEventDate, setNewEventDate] = useState('');
            const [newEventType, setNewEventType] = useState('deadline');
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');
            const [currentMonth, setCurrentMonth] = useState(new Date());

            useEffect(() => {
                if (!isAuthReady || !db || !userId) return;

                const unsubscribe = onSnapshot(
                    query(collection(db, `artifacts/${window.__app_id}/public/data/calendarEvents`)), // Asumsi acara kalender bersama
                    (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), date: doc.data().date.toDate() })); // Konversi timestamp ke Date
                        setEvents(data);
                    },
                    (error) => console.error("Gagal mengambil acara kalender:", error)
                );

                return () => unsubscribe();
            }, [db, userId, isAuthReady]);

            const handleAddEvent = async (e) => {
                e.preventDefault();
                if (!db || !userId || !isAuthReady) {
                    setMessage('Autentikasi belum siap. Silakan coba lagi.');
                    setMessageType('error');
                    return;
                }
                if (!newEventTitle || !newEventDate) {
                    setMessage('Harap isi judul dan tanggal acara.');
                    setMessageType('error');
                    return;
                }

                try {
                    await addDoc(collection(db, `artifacts/${window.__app_id}/public/data/calendarEvents`), {
                        title: newEventTitle,
                        date: new Date(newEventDate),
                        type: newEventType,
                        createdAt: new Date(),
                        addedBy: userId,
                    });
                    setMessage('Acara berhasil ditambahkan!');
                    setMessageType('success');
                    setNewEventTitle('');
                    setNewEventDate('');
                    setNewEventType('deadline');
                } catch (error) {
                    console.error("Kesalahan menambahkan acara:", error);
                    setMessage('Gagal menambahkan acara. Silakan coba lagi.');
                    setMessageType('error');
                }
            };

            const handleDeleteEvent = async (id) => {
                if (!db || !userId || !isAuthReady) return;
                try {
                    await deleteDoc(doc(db, `artifacts/${window.__app_id}/public/data/calendarEvents`, id));
                    setMessage('Acara berhasil dihapus!');
                    setMessageType('success');
                } catch (error) {
                    console.error("Kesalahan menghapus acara:", error);
                    setMessage('Gagal menghapus acara.');
                    setMessageType('error');
                }
            };

            const getEventTypeColor = (type) => {
                switch (type) {
                    case 'deadline': return 'bg-red-100 text-red-700';
                    case 'dateNight': return 'bg-pink-100 text-pink-700';
                    case 'anniversary': return 'bg-purple-100 text-purple-700';
                    default: return 'bg-gray-100 text-gray-700';
                }
            };

            // Logika untuk membuat kalender
            const daysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
            const firstDayOfMonth = (year, month) => new Date(year, month, 1).getDay(); // 0 for Sunday, 1 for Monday

            const renderCalendarDays = () => {
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth();
                const numDays = daysInMonth(year, month);
                const startDay = firstDayOfMonth(year, month); // Hari pertama dalam seminggu (0=Minggu, 1=Senin, dst.)

                const days = [];
                // Tambahkan hari kosong untuk mengisi awal bulan
                for (let i = 0; i < startDay; i++) {
                    days.push(<div key={`empty-${i}`} className="p-2 text-center text-gray-400 dark:text-gray-600"></div>);
                }

                for (let i = 1; i <= numDays; i++) {
                    const date = new Date(year, month, i);
                    const hasEvent = events.some(event =>
                        event.date.getDate() === i &&
                        event.date.getMonth() === month &&
                        event.date.getFullYear() === year
                    );
                    const today = new Date();
                    const isToday = date.getDate() === today.getDate() &&
                                    date.getMonth() === today.getMonth() &&
                                    date.getFullYear() === today.getFullYear();

                    const dayEvents = events.filter(event =>
                        event.date.getDate() === i &&
                        event.date.getMonth() === month &&
                        event.date.getFullYear() === year
                    );

                    days.push(
                        <div
                            key={i}
                            className={`p-2 text-center rounded-lg relative ${isToday ? 'bg-purple-200 dark:bg-purple-700 font-bold' : hasEvent ? 'bg-blue-100 dark:bg-blue-900' : 'bg-white dark:bg-gray-800'} shadow-sm`}
                        >
                            <span className="text-gray-900 dark:text-white">{i}</span>
                            {dayEvents.length > 0 && (
                                <div className="absolute bottom-1 left-0 right-0 flex justify-center space-x-1">
                                    {dayEvents.map((ev, idx) => (
                                        <span key={idx} className={`w-2 h-2 rounded-full ${ev.type === 'deadline' ? 'bg-red-500' : ev.type === 'dateNight' ? 'bg-pink-500' : ev.type === 'anniversary' ? 'bg-purple-500' : 'bg-gray-500'}`}></span>
                                    ))}
                                </div>
                            )}
                        </div>
                    );
                }
                return days;
            };

            const goToPreviousMonth = () => {
                setCurrentMonth(prevMonth => {
                    const newMonth = new Date(prevMonth);
                    newMonth.setMonth(newMonth.getMonth() - 1);
                    return newMonth;
                });
            };

            const goToNextMonth = () => {
                setCurrentMonth(prevMonth => {
                    const newMonth = new Date(prevMonth);
                    newMonth.setMonth(newMonth.getMonth() + 1);
                    return newMonth;
                });
            };

            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const dayNames = ["Min", "Sen", "Sel", "Rab", "Kam", "Jum", "Sab"];

            return (
                <div className="p-4 bg-gray-50 dark:bg-gray-900 min-h-screen">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-6">
                        <h2 className="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Kalender Pasangan & Acara</h2>

                        <NotificationMessage message={message} type={messageType} />

                        {/* Navigasi Kalender */}
                        <div className="flex justify-between items-center mb-4">
                            <button onClick={goToPreviousMonth} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300">
                                <ChevronLeft size={20} />
                            </button>
                            <h3 className="text-xl font-bold text-gray-900 dark:text-white">
                                {monthNames[currentMonth.getMonth()]} {currentMonth.getFullYear()}
                            </h3>
                            <button onClick={goToNextMonth} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300">
                                <ChevronLeft size={20} className="rotate-180" />
                            </button>
                        </div>

                        {/* Grid Kalender */}
                        <div className="grid grid-cols-7 gap-1 text-sm mb-6">
                            {dayNames.map(day => (
                                <div key={day} className="font-semibold text-center text-gray-700 dark:text-gray-300 p-2">
                                    {day}
                                </div>
                            ))}
                            {renderCalendarDays()}
                        </div>

                        <h3 className="text-xl font-bold mb-4 text-gray-900 dark:text-white">Tambah Acara Baru</h3>
                        <form onSubmit={handleAddEvent} className="space-y-4 mb-6">
                            <div>
                                <label htmlFor="newEventTitle" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Judul Acara</label>
                                <input
                                    type="text"
                                    id="newEventTitle"
                                    value={newEventTitle}
                                    onChange={(e) => setNewEventTitle(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    placeholder="Contoh: Batas Waktu Tagihan Listrik"
                                    required
                                />
                            </div>
                            <div>
                                <label htmlFor="newEventDate" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Tanggal</label>
                                <input
                                    type="date"
                                    id="newEventDate"
                                    value={newEventDate}
                                    onChange={(e) => setNewEventDate(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    required
                                />
                            </div>
                            <div>
                                <label htmlFor="newEventType" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Jenis Acara</label>
                                <select
                                    id="newEventType"
                                    value={newEventType}
                                    onChange={(e) => setNewEventType(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                >
                                    <option value="deadline">Batas Waktu Keuangan</option>
                                    <option value="dateNight">Kencan Malam</option>
                                    <option value="anniversary">Ulang Tahun</option>
                                    <option value="other">Lain-lain</option>
                                </select>
                            </div>
                            <button
                                type="submit"
                                className="w-full bg-gradient-to-r from-purple-400 to-pink-500 text-white py-3 rounded-full font-bold shadow-lg hover:from-purple-500 hover:to-pink-600 transition-all duration-300"
                            >
                                Tambah Acara
                            </button>
                        </form>

                        <h3 className="text-xl font-bold mb-4 text-gray-900 dark:text-white">Acara Mendatang</h3>
                        <div className="space-y-3">
                            {events.length === 0 ? (
                                <p className="text-gray-600 dark:text-gray-400">Belum ada acara yang dijadwalkan.</p>
                            ) : (
                                events.map((event) => (
                                    <div key={event.id} className="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl shadow-sm flex justify-between items-center">
                                        <div>
                                            <h4 className="text-lg font-semibold text-gray-900 dark:text-white">{event.title}</h4>
                                            <p className="text-sm text-gray-600 dark:text-gray-400">
                                                {event.date.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                                            </p>
                                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${getEventTypeColor(event.type)}`}>
                                                {event.type === 'deadline' ? 'Batas Waktu' : event.type === 'dateNight' ? 'Kencan Malam' : event.type === 'anniversary' ? 'Ulang Tahun' : 'Lain-lain'}
                                            </span>
                                        </div>
                                        <button onClick={() => handleDeleteEvent(event.id)} className="text-red-500 hover:text-red-700">
                                            <X size={20} />
                                        </button>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Komponen Pelacak Kebiasaan
        const HabitTrackerScreen = () => {
            const { db, userId, isAuthReady } = useContext(AppContext);
            const [habits, setHabits] = useState([]);
            const [newHabitName, setNewHabitName] = useState('');
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');

            useEffect(() => {
                if (!isAuthReady || !db || !userId) return;

                const unsubscribe = onSnapshot(
                    query(collection(db, `artifacts/${window.__app_id}/public/data/habits`)), // Asumsi kebiasaan bersama
                    (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setHabits(data);
                    },
                    (error) => console.error("Gagal mengambil kebiasaan:", error)
                );

                return () => unsubscribe();
            }, [db, userId, isAuthReady]);

            const handleAddHabit = async (e) => {
                e.preventDefault();
                if (!db || !userId || !isAuthReady) {
                    setMessage('Autentikasi belum siap. Silakan coba lagi.');
                    setMessageType('error');
                    return;
                }
                if (!newHabitName) {
                    setMessage('Harap isi nama kebiasaan.');
                    setMessageType('error');
                    return;
                }

                try {
                    await addDoc(collection(db, `artifacts/${window.__app_id}/public/data/habits`), {
                        name: newHabitName,
                        lukmanChecked: false,
                        destryChecked: false,
                        createdAt: new Date(),
                    });
                    setMessage('Kebiasaan berhasil ditambahkan!');
                    setMessageType('success');
                    setNewHabitName('');
                } catch (error) {
                    console.error("Kesalahan menambahkan kebiasaan:", error);
                    setMessage('Gagal menambahkan kebiasaan. Silakan coba lagi.');
                    setMessageType('error');
                }
            };

            const handleToggleHabit = async (id, userKey, currentValue) => {
                if (!db || !userId || !isAuthReady) return;
                try {
                    await updateDoc(doc(db, `artifacts/${window.__app_id}/public/data/habits`, id), {
                        [userKey]: !currentValue,
                    });
                    setMessage('Status kebiasaan berhasil diperbarui!');
                    setMessageType('success');
                } catch (error) {
                    console.error("Kesalahan memperbarui kebiasaan:", error);
                    setMessage('Gagal memperbarui kebiasaan.');
                    setMessageType('error');
                }
            };

            const handleDeleteHabit = async (id) => {
                if (!db || !userId || !isAuthReady) return;
                try {
                    await deleteDoc(doc(db, `artifacts/${window.__app_id}/public/data/habits`, id));
                    setMessage('Kebiasaan berhasil dihapus!');
                    setMessageType('success');
                } catch (error) {
                    console.error("Kesalahan menghapus kebiasaan:", error);
                    setMessage('Gagal menghapus kebiasaan.');
                    setMessageType('error');
                }
            };

            return (
                <div className="p-4 bg-gray-50 dark:bg-gray-900 min-h-screen">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-6">
                        <h2 className="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Pelacak Kebiasaan</h2>

                        <NotificationMessage message={message} type={messageType} />

                        <form onSubmit={handleAddHabit} className="space-y-4 mb-6">
                            <div>
                                <label htmlFor="newHabitName" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Nama Kebiasaan Baru</label>
                                <input
                                    type="text"
                                    id="newHabitName"
                                    value={newHabitName}
                                    onChange={(e) => setNewHabitName(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    placeholder="Contoh: Tidak Beli Kopi"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                className="w-full bg-gradient-to-r from-purple-400 to-pink-500 text-white py-3 rounded-full font-bold shadow-lg hover:from-purple-500 hover:to-pink-600 transition-all duration-300"
                            >
                                Tambah Kebiasaan
                            </button>
                        </form>

                        <h3 className="text-xl font-bold mb-4 text-gray-900 dark:text-white">Kebiasaan Anda</h3>
                        <div className="overflow-x-auto">
                            <table className="min-w-full bg-white dark:bg-gray-800 rounded-xl shadow-md">
                                <thead>
                                    <tr className="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 text-left text-sm font-semibold">
                                        <th className="p-3 rounded-tl-lg">Kebiasaan</th>
                                        <th className="p-3 text-center">Lukman</th>
                                        <th className="p-3 text-center">Destry</th>
                                        <th className="p-3 text-center">Progres</th>
                                        <th className="p-3 rounded-tr-lg">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {habits.length === 0 ? (
                                        <tr>
                                            <td colSpan="5" className="p-3 text-center text-gray-600 dark:text-gray-400">Belum ada kebiasaan yang dilacak.</td>
                                        </tr>
                                    ) : (
                                        habits.map((habit, index) => {
                                            const completedChecks = (habit.lukmanChecked ? 1 : 0) + (habit.destryChecked ? 1 : 0);
                                            const totalChecks = 2; // Lukman + Destry
                                            const progressPercentage = (completedChecks / totalChecks) * 100;
                                            return (
                                                <tr key={habit.id} className={`border-b border-gray-200 dark:border-gray-700 ${index % 2 === 0 ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-700'}`}>
                                                    <td className="p-3 text-gray-900 dark:text-white font-medium">{habit.name}</td>
                                                    <td className="p-3 text-center">
                                                        <input
                                                            type="checkbox"
                                                            checked={habit.lukmanChecked}
                                                            onChange={() => handleToggleHabit(habit.id, 'lukmanChecked', habit.lukmanChecked)}
                                                            className="form-checkbox h-5 w-5 text-purple-600 rounded focus:ring-purple-500 dark:bg-gray-600 dark:border-gray-500"
                                                        />
                                                    </td>
                                                    <td className="p-3 text-center">
                                                        <input
                                                            type="checkbox"
                                                            checked={habit.destryChecked}
                                                            onChange={() => handleToggleHabit(habit.id, 'destryChecked', habit.destryChecked)}
                                                            className="form-checkbox h-5 w-5 text-pink-600 rounded focus:ring-pink-500 dark:bg-gray-600 dark:border-gray-500"
                                                        />
                                                    </td>
                                                    <td className="p-3">
                                                        <div className="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-600">
                                                            <div
                                                                className="h-2.5 rounded-full bg-green-500"
                                                                style={{ width: `${progressPercentage}%` }}
                                                            ></div>
                                                        </div>
                                                        <p className="text-xs text-gray-600 dark:text-gray-400 mt-1 text-center">{completedChecks}/{totalChecks} ({progressPercentage.toFixed(0)}%)</p>
                                                    </td>
                                                    <td className="p-3 text-center">
                                                        <button onClick={() => handleDeleteHabit(habit.id)} className="text-red-500 hover:text-red-700">
                                                            <X size={20} />
                                                        </button>
                                                    </td>
                                                </tr>
                                            );
                                        })
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // Komponen Buku Harian
        const DiaryScreen = () => {
            const { db, userId, isAuthReady } = useContext(AppContext);
            const [diaryEntries, setDiaryEntries] = useState([]);
            const [newEntryText, setNewEntryText] = useState('');
            const [newEntryImage, setNewEntryImage] = useState(null);
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');

            useEffect(() => {
                if (!isAuthReady || !db || !userId) return;

                const unsubscribe = onSnapshot(
                    query(collection(db, `artifacts/${window.__app_id}/users/${userId}/diaryEntries`)),
                    (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), date: doc.data().date.toDate() }));
                        setDiaryEntries(data.sort((a, b) => b.date - a.date)); // Urutkan dari yang terbaru
                    },
                    (error) => console.error("Gagal mengambil entri buku harian:", error)
                );

                return () => unsubscribe();
            }, [db, userId, isAuthReady]);

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    setNewEntryImage(URL.createObjectURL(file));
                    setMessage('Gambar berhasil dipilih!');
                    setMessageType('success');
                }
            };

            const handleAddEntry = async (e) => {
                e.preventDefault();
                if (!db || !userId || !isAuthReady) {
                    setMessage('Autentikasi belum siap. Silakan coba lagi.');
                    setMessageType('error');
                    return;
                }
                if (!newEntryText) {
                    setMessage('Harap isi entri buku harian.');
                    setMessageType('error');
                    return;
                }

                try {
                    await addDoc(collection(db, `artifacts/${window.__app_id}/users/${userId}/diaryEntries`), {
                        text: newEntryText,
                        imageUrl: newEntryImage,
                        date: new Date(),
                        createdAt: new Date(),
                    });
                    setMessage('Entri buku harian berhasil ditambahkan!');
                    setMessageType('success');
                    setNewEntryText('');
                    setNewEntryImage(null);
                } catch (error) {
                    console.error("Kesalahan menambahkan entri buku harian:", error);
                    setMessage('Gagal menambahkan entri buku harian. Silakan coba lagi.');
                    setMessageType('error');
                }
            };

            const handleDeleteEntry = async (id) => {
                if (!db || !userId || !isAuthReady) return;
                try {
                    await deleteDoc(doc(db, `artifacts/${window.__app_id}/users/${userId}/diaryEntries`, id));
                    setMessage('Entri buku harian berhasil dihapus!');
                    setMessageType('success');
                } catch (error) {
                    console.error("Kesalahan menghapus entri buku harian:", error);
                    setMessage('Gagal menghapus entri buku harian.');
                    setMessageType('error');
                }
            };

            return (
                <div className="p-4 bg-gray-50 dark:bg-gray-900 min-h-screen">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-6">
                        <h2 className="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Buku Harian Pribadi</h2>

                        <NotificationMessage message={message} type={messageType} />

                        <form onSubmit={handleAddEntry} className="space-y-4 mb-6">
                            <div>
                                <label htmlFor="newEntryText" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Entri Baru</label>
                                <textarea
                                    id="newEntryText"
                                    value={newEntryText}
                                    onChange={(e) => setNewEntryText(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    placeholder="Refleksi harian Anda..."
                                    rows="5"
                                    required
                                ></textarea>
                            </div>
                            <div>
                                <label htmlFor="newEntryImage" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Lampirkan Gambar (Opsional)</label>
                                <input
                                    type="file"
                                    id="newEntryImage"
                                    accept="image/*"
                                    onChange={handleImageUpload}
                                    className="w-full text-gray-700 dark:text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"
                                />
                                {newEntryImage && (
                                    <img src={newEntryImage} alt="Pratinjau Entri Buku Harian" className="mt-4 w-32 h-32 object-cover rounded-lg shadow-md" />
                                )}
                            </div>
                            <button
                                type="submit"
                                className="w-full bg-gradient-to-r from-purple-400 to-pink-500 text-white py-3 rounded-full font-bold shadow-lg hover:from-purple-500 hover:to-pink-600 transition-all duration-300"
                            >
                                Tambah Entri
                            </button>
                        </form>

                        <h3 className="text-xl font-bold mb-4 text-gray-900 dark:text-white">Entri Buku Harian Anda</h3>
                        <div className="space-y-4">
                            {diaryEntries.length === 0 ? (
                                <p className="text-gray-600 dark:text-gray-400">Belum ada entri buku harian.</p>
                            ) : (
                                diaryEntries.map((entry) => (
                                    <div key={entry.id} className="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl shadow-sm">
                                        <div className="flex justify-between items-center mb-2">
                                            <p className="text-sm text-gray-600 dark:text-gray-400">
                                                {entry.date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}
                                            </p>
                                            <button onClick={() => handleDeleteEntry(entry.id)} className="text-red-500 hover:text-red-700">
                                                <X size={20} />
                                            </button>
                                        </div>
                                        <p className="text-gray-800 dark:text-gray-200 mb-2">{entry.text}</p>
                                        {entry.imageUrl && (
                                            <img src={entry.imageUrl} alt="Gambar Entri Buku Harian" className="w-full h-48 object-cover rounded-lg mt-2" />
                                        )}
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Komponen Notifikasi & Pengingat
        const NotificationsScreen = () => {
            const { db, userId, isAuthReady } = useContext(AppContext);
            const [reminders, setReminders] = useState([]);
            const [newReminderText, setNewReminderText] = useState('');
            const [newReminderDate, setNewReminderDate] = useState('');
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');

            useEffect(() => {
                if (!isAuthReady || !db || !userId) return;

                const unsubscribe = onSnapshot(
                    query(collection(db, `artifacts/${window.__app_id}/users/${userId}/reminders`)),
                    (snapshot) => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), date: doc.data().date.toDate() }));
                        setReminders(data.sort((a, b) => a.date - b.date));
                    },
                    (error) => console.error("Gagal mengambil pengingat:", error)
                );

                return () => unsubscribe();
            }, [db, userId, isAuthReady]);

            const handleAddReminder = async (e) => {
                e.preventDefault();
                if (!db || !userId || !isAuthReady) {
                    setMessage('Autentikasi belum siap. Silakan coba lagi.');
                    setMessageType('error');
                    return;
                }
                if (!newReminderText || !newReminderDate) {
                    setMessage('Harap isi teks dan tanggal pengingat.');
                    setMessageType('error');
                    return;
                }

                try {
                    await addDoc(collection(db, `artifacts/${window.__app_id}/users/${userId}/reminders`), {
                        text: newReminderText,
                        date: new Date(newReminderDate),
                        enabled: true,
                        createdAt: new Date(),
                    });
                    setMessage('Pengingat berhasil ditambahkan!');
                    setMessageType('success');
                    setNewReminderText('');
                    setNewReminderDate('');
                } catch (error) {
                    console.error("Kesalahan menambahkan pengingat:", error);
                    setMessage('Gagal menambahkan pengingat. Silakan coba lagi.');
                    setMessageType('error');
                }
            };

            const handleToggleReminder = async (id, currentStatus) => {
                if (!db || !userId || !isAuthReady) return;
                try {
                    await updateDoc(doc(db, `artifacts/${window.__app_id}/users/${userId}/reminders`, id), {
                        enabled: !currentStatus,
                    });
                    setMessage('Status pengingat berhasil diperbarui!');
                    setMessageType('success');
                } catch (error) {
                    console.error("Kesalahan memperbarui pengingat:", error);
                    setMessage('Gagal memperbarui pengingat.');
                    setMessageType('error');
                }
            };

            const handleDeleteReminder = async (id) => {
                if (!db || !userId || !isAuthReady) return;
                try {
                    await deleteDoc(doc(db, `artifacts/${window.__app_id}/users/${userId}/reminders`, id));
                    setMessage('Pengingat berhasil dihapus!');
                    setMessageType('success');
                } catch (error) {
                    console.error("Kesalahan menghapus pengingat:", error);
                    setMessage('Gagal menghapus pengingat.');
                    setMessageType('error');
                }
            };

            return (
                <div className="p-4 bg-gray-50 dark:bg-gray-900 min-h-screen">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 mb-6">
                        <h2 className="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Notifikasi & Pengingat</h2>

                        <NotificationMessage message={message} type={messageType} />

                        <form onSubmit={handleAddReminder} className="space-y-4 mb-6">
                            <div>
                                <label htmlFor="newReminderText" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Teks Pengingat</label>
                                <input
                                    type="text"
                                    id="newReminderText"
                                    value={newReminderText}
                                    onChange={(e) => setNewReminderText(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    placeholder="Contoh: Bayar Tagihan Listrik"
                                    required
                                />
                            </div>
                            <div>
                                <label htmlFor="newReminderDate" className="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Tanggal Pengingat</label>
                                <input
                                    type="date"
                                    id="newReminderDate"
                                    value={newReminderDate}
                                    onChange={(e) => setNewReminderDate(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                className="w-full bg-gradient-to-r from-purple-400 to-pink-500 text-white py-3 rounded-full font-bold shadow-lg hover:from-purple-500 hover:to-pink-600 transition-all duration-300"
                            >
                                Tambah Pengingat
                            </button>
                        </form>

                        <h3 className="text-xl font-bold mb-4 text-gray-900 dark:text-white">Pengingat Anda</h3>
                        <div className="space-y-4">
                            {reminders.length === 0 ? (
                                <p className="text-gray-600 dark:text-gray-400">Belum ada pengingat yang diatur.</p>
                            ) : (
                                reminders.map((reminder) => (
                                    <div key={reminder.id} className="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl shadow-sm flex justify-between items-center">
                                        <div>
                                            <h4 className="text-lg font-semibold text-gray-900 dark:text-white">{reminder.text}</h4>
                                            <p className="text-sm text-gray-600 dark:text-gray-400">
                                                {reminder.date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}
                                            </p>
                                        </div>
                                        <div className="flex items-center space-x-3">
                                            <button
                                                onClick={() => handleToggleReminder(reminder.id, reminder.enabled)}
                                                className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 ${reminder.enabled ? 'bg-green-500' : 'bg-gray-200 dark:bg-gray-600'}`}
                                            >
                                                <span
                                                    className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 ${reminder.enabled ? 'translate-x-6' : 'translate-x-1'}`}
                                                ></span>
                                            </button>
                                            <button onClick={() => handleDeleteReminder(reminder.id)} className="text-red-500 hover:text-red-700">
                                                <X size={20} />
                                            </button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // Komponen Pengaturan & Profil
        const SettingsScreen = () => {
            const { isDarkMode, toggleDarkMode, userId, db, isAuthReady } = useContext(AppContext);
            const [profileImage, setProfileImage] = useState(null);
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');

            // Memuat gambar profil dari Firestore saat komponen dimuat
            useEffect(() => {
                if (!db || !userId || !isAuthReady) return;

                const fetchProfile = async () => {
                    try {
                        const docRef = doc(db, `artifacts/${window.__app_id}/users/${userId}/profile`, 'main');
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists() && docSnap.data().profileImageUrl) {
                            setProfileImage(docSnap.data().profileImageUrl);
                        }
                    } catch (error) {
                        console.error("Gagal memuat gambar profil:", error);
                    }
                };
                fetchProfile();
            }, [db, userId, isAuthReady]);

            const handleImageUpload = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const imageUrl = URL.createObjectURL(file);
                    setProfileImage(imageUrl);
                    setMessage('Gambar profil berhasil dipilih! Menyimpan...');
                    setMessageType('success');

                    if (!db || !userId || !isAuthReady) {
                        setMessage('Autentikasi belum siap. Gambar tidak dapat disimpan.');
                        setMessageType('error');
                        return;
                    }

                    // Dalam aplikasi nyata, Anda akan mengunggah file ini ke Firebase Storage
                    // dan menyimpan URL yang dapat diakses publik di Firestore.
                    // Untuk demo ini, kita hanya menyimpan URL objek sementara di Firestore.
                    try {
                        await setDoc(doc(db, `artifacts/${window.__app_id}/users/${userId}/profile`, 'main'), {
                            profileImageUrl: imageUrl,
                            updatedAt: new Date(),
                        }, { merge: true }); // Gunakan merge untuk memperbarui dokumen yang ada
                        setMessage('Gambar profil berhasil diperbarui!');
                        setMessageType('success');
                    } catch (error) {
                        console.error("Gagal menyimpan gambar profil:", error);
                        setMessage('Gagal menyimpan gambar profil. Silakan coba lagi.');
                        setMessageType('error');
                    }
                }
            };

            const handleExportData = (format) => {
                // Placeholder untuk logika ekspor data
                setMessage(`Mengekspor data sebagai ${format}... (Fungsionalitas ini akan diimplementasikan di backend)`);
                setMessageType('info'); // Atau 'success' jika ini hanya demo
            };

            return (
                <div className="p-4 bg-gray-50 dark:bg-gray-900 min-h-screen">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
                        <h2 className="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Pengaturan & Profil</h2>

                        <NotificationMessage message={message} type={messageType} />

                        <div className="space-y-6">
                            {/* Pengaturan Mode Gelap */}
                            <div className="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-xl shadow-sm">
                                <div className="flex items-center space-x-3">
                                    {isDarkMode ? <Moon size={24} className="text-purple-500" /> : <Sun size={24} className="text-yellow-500" />}
                                    <span className="text-lg font-medium text-gray-900 dark:text-white">Mode Gelap</span>
                                </div>
                                <button
                                    onClick={toggleDarkMode}
                                    className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors duration-200 ${isDarkMode ? 'bg-purple-600' : 'bg-gray-200'}`}
                                >
                                    <span
                                        className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform duration-200 ${isDarkMode ? 'translate-x-6' : 'translate-x-1'}`}
                                    ></span>
                                </button>
                            </div>

                            {/* Info Profil */}
                            <div className="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl shadow-sm">
                                <h3 className="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Profil Anda</h3>
                                <div className="flex items-center space-x-4 mb-4">
                                    {/* Avatar Lukman */}
                                    <div className="relative w-20 h-20 rounded-full overflow-hidden border-2 border-pink-400">
                                        {profileImage ? (
                                            <img src={profileImage} alt="Profil Lukman" className="w-full h-full object-cover" />
                                        ) : (
                                            <div className="w-full h-full bg-gradient-to-br from-pink-400 to-purple-500 flex items-center justify-center text-white text-2xl font-bold">L</div>
                                        )}
                                        <input
                                            type="file"
                                            accept="image/*"
                                            onChange={handleImageUpload}
                                            className="absolute inset-0 opacity-0 cursor-pointer"
                                            title="Ganti foto profil Lukman"
                                        />
                                    </div>
                                    <div>
                                        <p className="text-gray-900 dark:text-white text-lg font-semibold">Lukman</p>
                                        <p className="text-gray-600 dark:text-gray-400 text-sm">lukman@example.com</p>
                                    </div>
                                </div>
                                {/* Avatar Destry (placeholder untuk ganti foto) */}
                                <div className="flex items-center space-x-4 mt-4">
                                    <div className="relative w-20 h-20 rounded-full overflow-hidden border-2 border-blue-400">
                                        {/* Untuk Destry, Anda akan memiliki state gambar terpisah atau logika yang lebih kompleks */}
                                        <div className="w-full h-full bg-gradient-to-br from-blue-400 to-green-500 flex items-center justify-center text-white text-2xl font-bold">D</div>
                                        <input
                                            type="file"
                                            accept="image/*"
                                            onChange={(e) => {
                                                const file = e.target.files[0];
                                                if (file) {
                                                    // Ini hanya demo, dalam aplikasi nyata perlu state terpisah untuk Destry
                                                    setMessage('Foto Destry berhasil dipilih! (Tidak disimpan dalam demo ini)');
                                                    setMessageType('info');
                                                }
                                            }}
                                            className="absolute inset-0 opacity-0 cursor-pointer"
                                            title="Ganti foto profil Destry"
                                        />
                                    </div>
                                    <div>
                                        <p className="text-gray-900 dark:text-white text-lg font-semibold">Destry</p>
                                        <p className="text-gray-600 dark:text-gray-400 text-sm">destry@example.com</p>
                                    </div>
                                </div>
                                {userId && (
                                    <p className="text-sm text-gray-500 dark:text-gray-400 mt-4 break-all">ID Pengguna: {userId}</p>
                                )}
                            </div>

                            {/* Ekspor Data & Laporan */}
                            <div className="p-4 bg-gray-50 dark:bg-gray-700 rounded-xl shadow-sm">
                                <h3 className="text-lg font-semibold mb-3 text-gray-900 dark:text-white">Ekspor Data & Laporan</h3>
                                <div className="space-y-3">
                                    <button
                                        onClick={() => handleExportData('PDF')}
                                        className="w-full flex items-center justify-center bg-blue-500 text-white py-3 rounded-full font-bold shadow-md hover:bg-blue-600 transition-colors duration-300"
                                    >
                                        <Download size={20} className="mr-2" /> Ekspor sebagai PDF
                                    </button>
                                    <button
                                        onClick={() => handleExportData('Email')}
                                        className="w-full flex items-center justify-center bg-purple-500 text-white py-3 rounded-full font-bold shadow-md hover:bg-purple-600 transition-colors duration-300"
                                    >
                                        <Send size={20} className="mr-2" /> Kirim via Email
                                    </button>
                                    <button
                                        onClick={() => handleExportData('Telegram')}
                                        className="w-full flex items-center justify-center bg-cyan-500 text-white py-3 rounded-full font-bold shadow-md hover:bg-cyan-600 transition-colors duration-300"
                                    >
                                        <Send size={20} className="mr-2" /> Kirim via Bot Telegram
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // Komponen Roda Kencan Siang dan Malam
        const DateWheelGame = ({ navigate }) => {
            const [mode, setMode] = useState('day'); // 'day' or 'night'
            const [selectedIdea, setSelectedIdea] = useState('');
            const [isSpinning, setIsSpinning] = useState(false);

            const dayIdeas = [
                "Piknik di taman",
                "Kunjungan ke museum/galeri seni",
                "Jalan-jalan di kebun raya",
                "Memasak bersama resep baru",
                "Bersepeda di sekitar kota",
                "Kunjungan ke pasar lokal",
                "Menonton film di bioskop",
                "Bermain mini golf",
                "Mencoba kafe baru",
                "Membaca buku bersama di perpustakaan"
            ];

            const nightIdeas = [
                "Makan malam romantis di rumah",
                "Menonton bintang di tempat sepi",
                "Malam film dengan selimut dan camilan",
                "Bermain game papan/kartu",
                "Mendengarkan musik dan berdansa",
                "Spa malam di rumah",
                "Menulis surat cinta satu sama lain",
                "Membuat koktail/mocktail bersama",
                "Berbicara tentang impian masa depan",
                "Sesi pijat pasangan"
            ];

            const spinWheel = () => {
                if (isSpinning) return;
                setIsSpinning(true);
                setSelectedIdea(''); // Kosongkan ide sebelumnya

                const ideas = mode === 'day' ? dayIdeas : nightIdeas;
                const randomIndex = Math.floor(Math.random() * ideas.length);
                const chosenIdea = ideas[randomIndex];

                // Simulasi putaran roda
                setTimeout(() => {
                    setSelectedIdea(chosenIdea);
                    setIsSpinning(false);
                }, 2000); // Durasi putaran
            };

            return (
                <div className="p-4 bg-gray-50 dark:bg-gray-900 min-h-screen flex flex-col items-center justify-center">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 w-full max-w-md text-center">
                        <h2 className="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Roda Kencan</h2>

                        <div className="flex justify-center space-x-4 mb-6">
                            <button
                                onClick={() => setMode('day')}
                                className={`px-6 py-3 rounded-full font-semibold transition-colors duration-200 ${mode === 'day' ? 'bg-yellow-400 text-white shadow-md' : 'bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300'}`}
                            >
                                Siang
                            </button>
                            <button
                                onClick={() => setMode('night')}
                                className={`px-6 py-3 rounded-full font-semibold transition-colors duration-200 ${mode === 'night' ? 'bg-purple-600 text-white shadow-md' : 'bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300'}`}
                            >
                                Malam
                            </button>
                        </div>

                        <div className="relative w-48 h-48 mx-auto mb-8">
                            <div
                                className={`w-full h-full rounded-full border-4 border-purple-400 dark:border-purple-600 flex items-center justify-center text-purple-600 dark:text-purple-400 text-4xl font-bold ${isSpinning ? 'animate-spin-slow' : ''}`}
                                style={{
                                    background: mode === 'day'
                                        ? 'linear-gradient(45deg, #FFD700, #FFA500)'
                                        : 'linear-gradient(45deg, #8A2BE2, #4B0082)',
                                    color: 'white',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontSize: '1.5rem',
                                    textAlign: 'center',
                                    padding: '1rem'
                                }}
                            >
                                {isSpinning ? 'Berputar...' : (mode === 'day' ? '☀️' : '🌙')}
                            </div>
                            <div className="absolute top-0 left-1/2 -translate-x-1/2 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[20px] border-b-red-500 -mt-2"></div>
                        </div>

                        <button
                            onClick={spinWheel}
                            disabled={isSpinning}
                            className="w-full bg-gradient-to-r from-purple-400 to-pink-500 text-white py-3 rounded-full font-bold shadow-lg hover:from-purple-500 hover:to-pink-600 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            {isSpinning ? 'Memutar...' : 'Putar Roda'}
                        </button>

                        {selectedIdea && (
                            <div className="mt-8 p-4 bg-purple-50 dark:bg-purple-900 rounded-lg shadow-inner">
                                <p className="text-lg font-semibold text-gray-900 dark:text-white">Ide Kencan Anda:</p>
                                <p className="text-2xl font-bold text-purple-700 dark:text-purple-300 mt-2">{selectedIdea}</p>
                            </div>
                        )}

                        <button
                            onClick={() => navigate('games')}
                            className="mt-6 flex items-center justify-center text-gray-600 dark:text-gray-400 hover:text-purple-500 transition-colors duration-200"
                        >
                            <ChevronLeft size={20} className="mr-2" /> Kembali ke Permainan
                        </button>
                    </div>
                </div>
            );
        };

        // Komponen Truth or Dare
        const TruthOrDareGame = ({ navigate }) => {
            const truths = [
                "Apa fantasi terliarmu yang belum pernah kamu ceritakan pada siapa pun?",
                "Apa hal paling 'nakal' yang pernah kamu lakukan di tempat umum?",
                "Jika kamu bisa menghabiskan satu malam dengan selebriti mana pun, siapa itu dan mengapa?",
                "Apa kebiasaan tersembunyi yang kamu miliki saat sendirian?",
                "Apa hal paling memalukan yang pernah kamu katakan atau lakukan di depan gebetan/pasangan?",
                "Apa pendapat jujurmu tentang 'one-night stand'?",
                "Pernahkah kamu mengirim atau menerima 'pesan nakal'? Ceritakan tanpa detail pribadi.",
                "Apa yang paling membuatmu tertarik secara fisik pada seseorang?",
                "Jika kamu bisa bertukar tubuh dengan pasanganmu selama sehari, apa hal pertama yang akan kamu lakukan?",
                "Apa hal paling berani yang pernah kamu lakukan di tempat tidur?",
                "Apa yang kamu anggap 'turn-on' terbesar yang mungkin mengejutkan orang lain?",
                "Pernahkah kamu berbohong tentang pengalaman seksualmu? Mengapa?",
                "Apa satu hal yang ingin kamu coba di ranjang tetapi belum pernah kamu lakukan?",
                "Apa pendapatmu tentang perselingkuhan emosional?",
                "Jika kamu bisa menonton ulang satu momen intim dalam hidupmu, apa itu dan mengapa?",
                "Apa hal paling tabu yang pernah kamu pikirkan?",
                "Apa hal yang paling kamu inginkan dari pasanganmu secara intim?",
                "Pernahkah kamu pura-pura menyukai sesuatu hanya untuk menyenangkan pasanganmu? Apa itu?",
                "Apa hal paling romantis (atau genit) yang pernah dilakukan seseorang untukmu?",
                "Jika kamu bisa menghidupkan kembali satu momen dari kencan pertamamu, apa itu dan mengapa?"
            ];

            const dares = [
                "Biarkan pasanganmu memilih pakaian dalammu untuk besok.",
                "Tunjukan godaan-godaan kamu ke pasangan, sampe membuat pasangan ingin menidurimu.",
                "Kirim pesan suara genit ke pasanganmu sekarang.",
                "Biarkan pasanganmu mengikat tanganmu dengan syal selama 10 menit dan lakukan hubungan intim.",
                "yang mendapatkan kartu ini bebas memilih apa yang mau di lakukan kepada pasangan",
                "Berikan pasanganmu pijatan plus-plus yang sensual selama 5 menit.",
                "Posting 'fotbar bersama pasanganmu di media sosial.",
                "lakukan ciuman mesra bersama pasanganmu selamat 2 menit.",
                "Tiru suara desahan yang paling meyakinkan yang kamu bisa.",
                "Buka bajumu dan celana dalamu selama 10 menit",
                "Tuliskan 3 hal yang paling kamu sukai dari tubuh pasanganmu dan bacakan keras-keras.",
                "Lakukan 'eye contact challenge' yang intens dengan pasanganmu selama 1 menit tanpa tertawa.",
                "Berikan pasanganmu 'gigitan cinta' di leher (ringan, jangan sampai memar!).",
                "Ganti pakaianmu menjadi sesuatu yang genit dan lakukan 'catwalk' di depan pasanganmu.",
                "Kirimkan 'emoji nakal' ke pasanganmu dan jelaskan artinya.",
                "Berikan pasanganmu ciuman yang paling bergairah yang kamu bisa.",
                "Berjalanlah di sekitar ruangan hanya dengan pakaian dalammu selama 1 menit.",
                "Ceritakan fantasi terliarmu dalam 30 detik.",
                "Biarkan pasanganmu mengoleskan dan memainkanya (kedalam keintimanmu).",
                "Lakukan 'pelukan erat' yang panjang dan sensual dengan pasanganmu selama 5 menit."
            ];

            const punishments = [
                "Lakukan 10 push-up di atas pasanganmu.",
                "Nyanyikan lagu yang menggoda pasangan.",
                "Berikan pujian tulus kepada setiap pemain lain.",
                "Makan satu sendok teh saus pedas (jika aman).",
                "Lakukan hal yang mesra kepada pasanganmu.",
                "Ceritakan lelucon terburuk yang kamu tahu.",
                "Tiru suara hewan selama 30 detik.",
                "Biarkan pemain lain menggambar sesuatu di wajahmu.",
                "lakukan 10 sit up di atas pasanganmu.",
                "Berikan pijatan plus-plus kepada pasangan."
            ];

            const [currentCard, setCurrentCard] = useState(null); // { type: 'truth'/'dare'/'punishment', text: '...' }
            const [showCard, setShowCard] = useState(false);

            const getRandomCard = (type) => {
                let list;
                let title;
                let bgColor;
                switch (type) {
                    case 'truth':
                        list = truths;
                        title = 'Kebenaran';
                        bgColor = 'bg-blue-100 dark:bg-blue-900';
                        break;
                    case 'dare':
                        list = dares;
                        title = 'Tantangan';
                        bgColor = 'bg-red-100 dark:bg-red-900';
                        break;
                    case 'punishment':
                        list = punishments;
                        title = 'Hukuman';
                        bgColor = 'bg-yellow-100 dark:bg-yellow-900';
                        break;
                    default:
                        return;
                }
                const randomIndex = Math.floor(Math.random() * list.length);
                setCurrentCard({ type: title, text: list[randomIndex], bgColor });
                setShowCard(true);
            };

            const handleBackToGame = () => {
                setShowCard(false);
                setCurrentCard(null);
            };

            return (
                <div className="p-4 bg-gray-50 dark:bg-gray-900 min-h-screen flex flex-col items-center justify-center">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 w-full max-w-md text-center">
                        <h2 className="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Truth or Dare</h2>

                        {!showCard ? (
                            <div className="space-y-4">
                                <button
                                    onClick={() => getRandomCard('truth')}
                                    className="w-full bg-gradient-to-r from-blue-400 to-cyan-500 text-white py-3 rounded-full font-bold shadow-lg hover:from-blue-500 hover:to-cyan-600 transition-all duration-300"
                                >
                                    Ambil Kebenaran
                                </button>
                                <button
                                    onClick={() => getRandomCard('dare')}
                                    className="w-full bg-gradient-to-r from-red-400 to-pink-500 text-white py-3 rounded-full font-bold shadow-lg hover:from-red-500 hover:to-pink-600 transition-all duration-300"
                                >
                                    Ambil Tantangan
                                </button>
                                <button
                                    onClick={() => getRandomCard('punishment')}
                                    className="w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white py-3 rounded-full font-bold shadow-lg hover:from-yellow-500 hover:to-orange-600 transition-all duration-300"
                                >
                                    Ambil Hukuman
                                </button>
                            </div>
                        ) : (
                            <div className={`p-6 rounded-xl shadow-lg ${currentCard.bgColor} text-gray-900 dark:text-white`}>
                                <h3 className="text-xl font-bold mb-4">{currentCard.type}</h3>
                                <p className="text-lg mb-6">{currentCard.text}</p>
                                <button
                                    onClick={handleBackToGame}
                                    className="bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-gray-200 py-2 px-6 rounded-full font-semibold hover:bg-gray-400 dark:hover:bg-gray-600 transition-colors duration-200"
                                >
                                    <RotateCcw size={20} className="inline-block mr-2" /> Kembali
                                </button>
                            </div>
                        )}

                        <button
                            onClick={() => navigate('games')}
                            className="mt-6 flex items-center justify-center text-gray-600 dark:text-gray-400 hover:text-purple-500 transition-colors duration-200 mx-auto"
                        >
                            <ChevronLeft size={20} className="mr-2" /> Kembali ke Permainan
                        </button>
                    </div>
                </div>
            );
        };

        // Komponen Menu Permainan
        const GamesScreen = ({ navigate }) => {
            return (
                <div className="p-4 bg-gray-50 dark:bg-gray-900 min-h-screen flex flex-col items-center justify-center">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 w-full max-w-md text-center">
                        <h2 className="text-2xl font-bold mb-8 text-gray-900 dark:text-white">Pilih Permainan</h2>
                        <div className="space-y-4">
                            <button
                                onClick={() => navigate('dateWheelGame')}
                                className="w-full bg-gradient-to-r from-purple-400 to-pink-500 text-white py-4 rounded-full font-bold text-lg shadow-lg hover:from-purple-500 hover:to-pink-600 transition-all duration-300 flex items-center justify-center"
                            >
                                <Heart size={24} className="mr-3" /> Roda Kencan
                            </button>
                            <button
                                onClick={() => navigate('truthOrDareGame')}
                                className="w-full bg-gradient-to-r from-teal-400 to-blue-500 text-white py-4 rounded-full font-bold text-lg shadow-lg hover:from-teal-500 hover:to-blue-600 transition-all duration-300 flex items-center justify-center"
                            >
                                <Award size={24} className="mr-3" /> Truth or Dare
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // Komponen Login/Onboarding
        const LoginScreen = ({ navigate }) => {
            const { auth, setUser } = useContext(AppContext);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');
            const [isRegistering, setIsRegistering] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setMessage('');
                setMessageType('');

                if (!auth) {
                    setMessage('Layanan autentikasi tidak tersedia.');
                    setMessageType('error');
                    return;
                }

                try {
                    if (isRegistering) {
                        await createUserWithEmailAndPassword(auth, email, password);
                        setMessage('Pendaftaran berhasil! Anda sekarang dapat login.');
                        setMessageType('success');
                        setIsRegistering(false); // Kembali ke mode login setelah pendaftaran
                    } else {
                        await signInWithEmailAndPassword(auth, email, password);
                        setMessage('Login berhasil!');
                        setMessageType('success');
                        // Setelah login berhasil, Firebase onAuthStateChanged akan memperbarui state user
                        // dan App akan secara otomatis menavigasi ke dashboard.
                    }
                } catch (error) {
                    console.error("Kesalahan autentikasi:", error);
                    let errorMessage = 'Terjadi kesalahan autentikasi.';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'Email sudah digunakan.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Format email tidak valid.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Kata sandi terlalu lemah (minimal 6 karakter).';
                    } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        errorMessage = 'Email atau kata sandi salah.';
                    }
                    setMessage(errorMessage);
                    setMessageType('error');
                }
            };

            return (
                <div className="p-4 bg-gray-50 dark:bg-gray-900 min-h-screen flex items-center justify-center">
                    <div className="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 w-full max-w-sm text-center">
                        <h2 className="text-3xl font-bold mb-6 text-gray-900 dark:text-white">
                            {isRegistering ? 'Daftar' : 'Login'} ke LuDesTrack
                        </h2>

                        <NotificationMessage message={message} type={messageType} />

                        <form onSubmit={handleAuth} className="space-y-4">
                            <div>
                                <input
                                    type="email"
                                    placeholder="Email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    required
                                />
                            </div>
                            <div>
                                <input
                                    type="password"
                                    placeholder="Kata Sandi"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                    required
                                />
                            </div>
                            <button
                                type="submit"
                                className="w-full bg-gradient-to-r from-purple-400 to-pink-500 text-white py-3 rounded-full font-bold shadow-lg hover:from-purple-500 hover:to-pink-600 transition-all duration-300"
                            >
                                {isRegistering ? 'Daftar Akun' : 'Login'}
                            </button>
                        </form>

                        <button
                            onClick={() => setIsRegistering(!isRegistering)}
                            className="mt-4 text-purple-600 dark:text-purple-400 hover:underline text-sm"
                        >
                            {isRegistering ? 'Sudah punya akun? Login di sini.' : 'Belum punya akun? Daftar di sini.'}
                        </button>
                    </div>
                </div>
            );
        };


        // Komponen Utama Aplikasi
        const App = () => {
            const { user, isAuthReady, showAuthModal, setShowAuthModal } = useContext(AppContext);
            const [currentPage, setCurrentPage] = useState('login'); // Default ke halaman login
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);

            // Navigasi setelah autentikasi berhasil
            useEffect(() => {
                if (isAuthReady && user) {
                    setCurrentPage('dashboard');
                } else if (isAuthReady && !user) {
                    setCurrentPage('login');
                }
            }, [user, isAuthReady]);

            const navigate = (page) => {
                setCurrentPage(page);
            };

            const toggleSidebar = () => {
                setIsSidebarOpen(!isSidebarOpen);
            };

            let pageTitle = '';
            switch (currentPage) {
                case 'login':
                    pageTitle = 'Selamat Datang';
                    break;
                case 'dashboard':
                    pageTitle = 'Dasbor';
                    break;
                case 'addTransaction':
                    pageTitle = 'Tambah Transaksi';
                    break;
                case 'budgetSetup':
                    pageTitle = 'Perencanaan Anggaran';
                    break;
                case 'savingsTracker':
                    pageTitle = 'Tujuan Tabungan';
                    break;
                case 'wishlist':
                    pageTitle = 'Daftar Keinginan';
                    break;
                case 'coupleCalendar':
                    pageTitle = 'Kalender Pasangan';
                    break;
                case 'habitTracker':
                    pageTitle = 'Pelacak Kebiasaan';
                    break;
                case 'diary':
                    pageTitle = 'Buku Harian';
                    break;
                case 'notifications':
                    pageTitle = 'Notifikasi';
                    break;
                case 'settings':
                    pageTitle = 'Pengaturan';
                    break;
                case 'games':
                    pageTitle = 'Permainan';
                    break;
                case 'dateWheelGame':
                    pageTitle = 'Roda Kencan';
                    break;
                case 'truthOrDareGame':
                    pageTitle = 'Truth or Dare';
                    break;
                default:
                    pageTitle = 'LuDesTrack';
            }

            return (
                <div className="font-inter antialiased text-gray-900 dark:bg-gray-900 dark:text-white min-h-screen flex flex-col">
                    {/* Overlay untuk Sidebar */}
                    {isSidebarOpen && (
                        <div
                            className="fixed inset-0 bg-black bg-opacity-50 z-30"
                            onClick={toggleSidebar}
                        ></div>
                    )}

                    {/* Header hanya ditampilkan jika bukan di halaman login */}
                    {currentPage !== 'login' && <AppHeader toggleSidebar={toggleSidebar} title={pageTitle} />}

                    {/* Sidebar hanya ditampilkan jika bukan di halaman login */}
                    {currentPage !== 'login' && <Sidebar isOpen={isSidebarOpen} toggleSidebar={toggleSidebar} navigate={navigate} />}

                    <main className="flex-grow">
                        {/* Tampilkan modal otentikasi jika ada masalah */}
                        <CustomModal
                            show={showAuthModal}
                            title="Kesalahan Autentikasi"
                            message="Terjadi kesalahan saat menginisialisasi layanan autentikasi. Beberapa fitur mungkin tidak berfungsi dengan benar. Harap coba muat ulang halaman."
                            onClose={() => setShowAuthModal(false)}
                        />

                        {!isAuthReady ? (
                            <div className="flex items-center justify-center min-h-[calc(100vh-64px)] text-gray-700 dark:text-gray-300">
                                Memuat aplikasi dan mengautentikasi...
                            </div>
                        ) : (
                            <>
                                {currentPage === 'login' && <LoginScreen navigate={navigate} />}
                                {currentPage === 'dashboard' && <DashboardScreen />}
                                {currentPage === 'addTransaction' && <AddTransactionScreen />}
                                {currentPage === 'budgetSetup' && <BudgetSetupScreen />}
                                {currentPage === 'savingsTracker' && <SavingsTrackerScreen />}
                                {currentPage === 'wishlist' && <WishlistScreen />}
                                {currentPage === 'coupleCalendar' && <CoupleCalendarScreen />}
                                {currentPage === 'habitTracker' && <HabitTrackerScreen />}
                                {currentPage === 'diary' && <DiaryScreen />}
                                {currentPage === 'notifications' && <NotificationsScreen />}
                                {currentPage === 'settings' && <SettingsScreen />}
                                {currentPage === 'games' && <GamesScreen navigate={navigate} />}
                                {currentPage === 'dateWheelGame' && <DateWheelGame navigate={navigate} />}
                                {currentPage === 'truthOrDareGame' && <TruthOrDareGame navigate={navigate} />}
                            </>
                        )}
                    </main>
                </div>
            );
        };

        // Render aplikasi ke DOM
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AppProvider><App /></AppProvider>);
    </script>
</body>
</html>
